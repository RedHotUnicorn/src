---
title: –£—Å–∫–æ—Ä—è–µ–º Python –≤ —Å—Ç–æ —Ä–∞–∑ –ø—Ä–∏ –ø–æ–º–æ—â–∏ –º–µ–Ω–µ–µ —á–µ–º —Å—Ç–∞ —Å—Ç—Ä–æ–∫ –Ω–∞ Rust / –•–∞–±—Ä
date: 2023-05-02
src_link: https://www.notion.so/Python-Rust-d73ec3ba123c4b039b8a2d67d78aec64
src_date: '2023-05-02 09:48:00'
gold_link: https://habr.com/ru/companies/ruvds/articles/732530/
gold_link_hash: 48f6412bf65d5785adb7655cb8bf5203
tags:
- '#host_habr_com'
---

[![](https://habrastorage.org/r/w780q1/webt/ve/wi/bl/vewibluh8e0erhybvpmggohupnw.jpeg)](https://habr.com/ru/company/ruvds/blog/732530/)  

–û–¥–Ω–∞–∂–¥—ã –Ω–∞ —Ä–∞–±–æ—Ç–µ —É –Ω–∞—Å –≤–æ–∑–Ω–∏–∫–ª–∞ –ø—Ä–æ–±–ª–µ–º–∞ —Å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é –æ–¥–Ω–æ–π –∏–∑ –Ω–∞—à–∏—Ö –æ—Å–Ω–æ–≤–Ω—ã—Ö Python-–±–∏–±–ª–∏–æ—Ç–µ–∫.  

  

–≠—Ç–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç –Ω–∞—à–µ–≥–æ –∫–æ–Ω–≤–µ–π–µ—Ä–∞ 3D-–æ–±—Ä–∞–±–æ—Ç–∫–∏. –≠—Ç–æ –¥–æ–≤–æ–ª—å–Ω–æ –±–æ–ª—å—à–∞—è –∏ —Å–ª–æ–∂–Ω–∞—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞, –∏—Å–ø–æ–ª—å–∑—É—é—â–∞—è NumPy –∏ –¥—Ä—É–≥–∏–µ –Ω–∞—É—á–Ω—ã–µ –ø–∞–∫–µ—Ç—ã Python –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —à–∏—Ä–æ–∫–æ–≥–æ —Å–ø–µ–∫—Ç—Ä–∞ –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –∏ –≥–µ–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π.  

  

–ö—Ä–æ–º–µ —Ç–æ–≥–æ, –Ω–∞—à–∞ —Å–∏—Å—Ç–µ–º–∞ –¥–æ–ª–∂–Ω–∞ —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–∞ –º–æ—â–Ω–æ—Å—Ç—è—Ö –∫–æ–º–ø–∞–Ω–∏–∏ —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–º–∏ —Ä–µ—Å—É—Ä—Å–∞–º–∏ CPU, –∏ —Ö–æ—Ç—è –ø–æ–Ω–∞—á–∞–ª—É –æ–Ω–∞ —Å–ø—Ä–∞–≤–ª—è–ª–∞—Å—å —Ö–æ—Ä–æ—à–æ, —Å —Ä–æ—Å—Ç–æ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∏–∑–∏—á–µ—Å–∫–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —É –Ω–∞—Å –Ω–∞—á–∞–ª–∏ –≤–æ–∑–Ω–∏–∫–∞—Ç—å –ø—Ä–æ–±–ª–µ–º—ã, –∞ –Ω–∞—à–∞ —Å–∏—Å—Ç–µ–º–∞ –µ–¥–≤–∞ –≤—ã–¥–µ—Ä–∂–∏–≤–∞–ª–∞ –Ω–∞–≥—Ä—É–∑–∫—É.  

  

–ú—ã –ø—Ä–∏—à–ª–∏ –∫ –≤—ã–≤–æ–¥—É, —á—Ç–æ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —É–≤–µ–ª–∏—á–∏–≤—à–µ–π—Å—è –Ω–∞–≥—Ä—É–∑–∫–æ–π –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å —Å–∏—Å—Ç–µ–º—É, –ø–æ –∫—Ä–∞–π–Ω–µ–π –º–µ—Ä–µ, –≤ –ø—è—Ç—å–¥–µ—Å—è—Ç —Ä–∞–∑ –±—ã—Å—Ç—Ä–µ–µ, –∏ —Ä–µ—à–∏–ª–∏, —á—Ç–æ –ø–æ–º–æ—á—å –≤ —ç—Ç–æ–º –Ω–∞–º –º–æ–∂–µ—Ç Rust.  

  

–¢–∞–∫ –∫–∞–∫ –ø—Ä–æ–±–ª–µ–º—ã –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏, —Å –∫–æ—Ç–æ—Ä—ã–º–∏ –º—ã —Å—Ç–æ–ª–∫–Ω—É–ª–∏—Å—å, –≤—Å—Ç—Ä–µ—á–∞—é—Ç—Å—è –¥–æ–≤–æ–ª—å–Ω–æ —á–∞—Å—Ç–æ, –º—ã –º–æ–∂–µ–º –≤–æ—Å—Å–æ–∑–¥–∞—Ç—å –∏ —Ä–µ—à–∏—Ç—å –∏—Ö –ø—Ä—è–º–æ –∑–¥–µ—Å—å, –≤ (–Ω–µ —Ç–∞–∫–æ–π —É–∂ –∫–æ—Ä–æ—Ç–∫–æ–π) —Å—Ç–∞—Ç—å–µ.  

  

–¢–∞–∫ —á—Ç–æ –∑–∞–≤–∞—Ä–∏—Ç–µ —Å–µ–±–µ —á–∞—é (–∏–ª–∏ –∫–æ—Ñ–µ) –∏ —è —Ä–∞—Å—Å–∫–∞–∂—É –≤–∞–º (–∞) –æ —Å–∞–º–æ–π –ø—Ä–æ–±–ª–µ–º–µ –∏ (–±) –æ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∏—Ç–µ—Ä–∞—Ü–∏—è—Ö –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π, –∫–æ—Ç–æ—Ä—ã–µ –º—ã —Å–º–æ–≥–ª–∏ –ø—Ä–∏–º–µ–Ω–∏—Ç—å –¥–ª—è —Ä–µ—à–µ–Ω–∏—è —ç—Ç–æ–π –ø—Ä–æ–±–ª–µ–º—ã.  

  

–ï—Å–ª–∏ –≤—ã —Ö–æ—Ç–∏—Ç–µ —Å—Ä–∞–∑—É –ø–µ—Ä–µ–π—Ç–∏ –∫ –ø–æ–ª—É—á–∏–≤—à–µ–º—É—Å—è –∫–æ–¥—É, —Ç–æ —á–∏—Ç–∞–π—Ç–µ —Ä–∞–∑–¥–µ–ª ¬´–ü–æ–¥–≤–µ–¥–µ–Ω–∏–µ –∏—Ç–æ–≥–æ–≤¬ª.  

  

‚ñç –ù–∞—à –ø—Ä–∏–º–µ—Ä
------------

  

–î–∞–≤–∞–π—Ç–µ —Å–æ–∑–¥–∞–¥–∏–º –Ω–µ–±–æ–ª—å—à—É—é –±–∏–±–ª–∏–æ—Ç–µ–∫—É, –∫–æ—Ç–æ—Ä–∞—è –±—É–¥–µ—Ç –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–∞—à–∏ –∏—Å—Ö–æ–¥–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ (–æ–¥–Ω–∞–∫–æ –≤—ã–ø–æ–ª–Ω—è—é—â–∞—è —Å–æ–≤–µ—Ä—à–µ–Ω–Ω–æ –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω—É—é —Ä–∞–±–æ—Ç—É).  

  

–ü—Ä–µ–¥—Å—Ç–∞–≤—å—Ç–µ, —á—Ç–æ —É –≤–∞—Å –µ—Å—Ç—å —Å–ø–∏—Å–æ–∫ –º–Ω–æ–≥–æ—É–≥–æ–ª—å–Ω–∏–∫–æ–≤ –∏ —Å–ø–∏—Å–æ–∫ —Ç–æ—á–µ–∫, –≤—Å—ë —ç—Ç–æ –≤ 2D. –î–ª—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏ –Ω–∞–º –Ω—É–∂–Ω–æ ¬´—Å–æ–ø–æ—Å—Ç–∞–≤–∏—Ç—å¬ª –∫–∞–∂–¥—É—é —Ç–æ—á–∫—É —Å –æ–¥–Ω–∏–º –º–Ω–æ–≥–æ—É–≥–æ–ª—å–Ω–∏–∫–æ–º.  

  

–ù–∞—à–∞ –≤—ã–º—ã—à–ª–µ–Ω–Ω–∞—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –±—É–¥–µ—Ç:  

  

1. –ù–∞—á–∏–Ω–∞—Ç—å —Å –∏—Å—Ö–æ–¥–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞ —Ç–æ—á–µ–∫ –∏ –º–Ω–æ–≥–æ—É–≥–æ–ª—å–Ω–∏–∫–æ–≤ (–≤ 2D).
2. –î–ª—è –∫–∞–∂–¥–æ–π —Ç–æ—á–∫–∏ –Ω–∞ –æ—Å–Ω–æ–≤–∞–Ω–∏–∏ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è –¥–æ —Ü–µ–Ω—Ç—Ä–∞ –Ω–∞—Ö–æ–¥–∏—Ç—å –≥–æ—Ä–∞–∑–¥–æ –º–µ–Ω—å—à–µ–µ –ø–æ–¥–º–Ω–æ–∂–µ—Å—Ç–≤–æ –º–Ω–æ–≥–æ—É–≥–æ–ª—å–Ω–∏–∫–æ–≤, –±–ª–∏–∂–∞–π—à–∏—Ö –∫ –Ω–µ–π.
3. –ò–∑ —ç—Ç–∏—Ö –º–Ω–æ–≥–æ—É–≥–æ–ª—å–Ω–∏–∫–æ–≤ –≤—ã–±–∏—Ä–∞—Ç—å ¬´–ª—É—á—à–∏–π¬ª (–≤ –∫–∞—á–µ—Å—Ç–≤–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª—è ¬´–ª—É—á—à–µ–≥–æ¬ª –º—ã –±—É–¥–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å ¬´—Å –Ω–∞–∏–º–µ–Ω—å—à–µ–π –ø–ª–æ—â–∞–¥—å—é¬ª).

  

–í –∫–æ–¥–µ —ç—Ç–æ –±—É–¥–µ—Ç –≤—ã–≥–ª—è–¥–µ—Ç—å —Ç–∞–∫ (–ø–æ–ª–Ω—ã–π –∫–æ–¥ –º–æ–∂–Ω–æ –Ω–∞–π—Ç–∏ [–∑–¥–µ—Å—å](https://github.com/ohadravid/poly-match)):  

  


```
from typing import List, Tuple
import numpy as np
from dataclasses import dataclass
from functools import cached_property

Point = np.array

@dataclass
class Polygon:
    x: np.array
    y: np.array

    @cached_property
    def center(self) -> Point: ...
    def area(self) -> float: ...

def find_close_polygons(polygon_subset: List[Polygon], point: Point, max_dist: float) -> List[Polygon]:
    ...

def select_best_polygon(polygon_sets: List[Tuple[Point, List[Polygon]]]) -> List[Tuple[Point, Polygon]]:
    ...

def main(polygons: List[Polygon], points: np.ndarray) -> List[Tuple[Point, Polygon]]:
    ...
```
  

**–û—Å–Ω–æ–≤–Ω–∞—è —Å–ª–æ–∂–Ω–æ—Å—Ç—å (—Å —Ç–æ—á–∫–∏ –∑—Ä–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏) –∑–∞–∫–ª—é—á–∞–µ—Ç—Å—è –≤ —Å–º–µ—à–µ–Ω–∏–∏ –æ–±—ä–µ–∫—Ç–æ–≤ Python –∏ –º–∞—Å—Å–∏–≤–æ–≤ numpy.**  

  

–°–∫–æ—Ä–æ –º—ã –ø–æ–¥—Ä–æ–±–Ω–æ —ç—Ç–æ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º.  

  

–°—Ç–æ–∏—Ç –∑–∞–º–µ—Ç–∏—Ç—å, —á—Ç–æ –¥–ª—è —ç—Ç–æ–≥–æ –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –ø—Ä–∏–º–µ—Ä–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –º–æ–∂–Ω–æ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å —á–∞—Å—Ç–∏/–≤—Å—ë —Ü–µ–ª–∏–∫–æ–º –≤ [–≤–µ–∫—Ç–æ—Ä–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π](https://numpy.org/doc/stable/glossary.html#term-vectorization) numpy, –Ω–æ —ç—Ç–æ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ –¥–ª—è —Ä–µ–∞–ª—å–Ω–æ–π –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –∏ –ø—Ä–∏ —ç—Ç–æ–º –¥–µ–ª–∞–µ—Ç –∫–æ–¥ –≥–æ—Ä–∞–∑–¥–æ –º–µ–Ω–µ–µ —á–∏—Ç–∞–µ–º—ã–º –∏ –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä—É–µ–º—ã–º, –∞ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –æ–∫–∞–∂—É—Ç—Å—è –Ω–µ–∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã–º–∏ ([–∑–¥–µ—Å—å](https://github.com/ohadravid/poly-match/blob/main/poly_match_v1_5_vectorized.py) –Ω–∞—Ö–æ–¥–∏—Ç—Å—è —á–∞—Å—Ç–∏—á–Ω–æ –≤–µ–∫—Ç–æ—Ä–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è, –∫–æ—Ç–æ—Ä–∞—è –±—ã—Å—Ç—Ä–µ–µ, –Ω–æ –¥–∞–ª–µ–∫–∞ –æ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –º—ã –¥–æ—Å—Ç–∏–≥–Ω–µ–º).  

  

–ö—Ä–æ–º–µ —Ç–æ–≥–æ, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ª—é–±—ã—Ö —Ç—Ä—é–∫–æ–≤ —Å JIT (PyPy / numba) –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ –æ—á–µ–Ω—å –º–∞–ª–µ–Ω—å–∫–æ–π –≤—ã–≥–æ–¥–µ (—á—Ç–æ–±—ã —É–±–µ–¥–∏—Ç—å—Å—è, –º—ã –∏–∑–º–µ—Ä–∏–º —ç—Ç–æ).  

  

‚ñç –ü–æ—á–µ–º—É –±—ã –ø—Ä–æ—Å—Ç–æ –Ω–µ –ü–µ—Ä–µ–ø–∏—Å–∞—Ç—å –í—Å—ë –ù–∞ Rust‚Ñ¢?
----------------------------------------------

  

–ö–∞–∫ –Ω–∏ –ø—Ä–∏–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω–æ –±—ã–ª–æ –ø–æ–ª–Ω–æ–µ –ø–µ—Ä–µ–ø–∏—Å—ã–≤–∞–Ω–∏–µ, –æ–Ω–æ –∏–º–µ–ª–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø—Ä–æ–±–ª–µ–º:  

  

1. –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ —É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∞ numpy –¥–ª—è –º–Ω–æ–≥–∏—Ö —Å–≤–æ–∏—Ö –≤—ã—á–∏—Å–ª–µ–Ω–∏–π, —Ç–∞–∫ –ø–æ—á–µ–º—É –º—ã –¥–æ–ª–∂–Ω—ã –æ–∂–∏–¥–∞—Ç—å, —á—Ç–æ Rust –±—É–¥–µ—Ç –ª—É—á—à–µ?
2. –û–Ω–∞ –±–æ–ª—å—à–∞—è, —Å–ª–æ–∂–Ω–∞—è, –æ—á–µ–Ω—å –≤–∞–∂–Ω–∞—è –¥–ª—è –±–∏–∑–Ω–µ—Å–∞ –∏ –≤—ã—Å–æ–∫–æ–∞–ª–≥–æ—Ä–∏—Ç–º–∏—á–µ—Å–∫–∞—è, –ø–æ—ç—Ç–æ–º—É —ç—Ç–æ –∑–∞–π–º—ë—Ç –º–µ—Å—è—Ü—ã —Ä–∞–±–æ—Ç—ã, –∞ –±–µ–¥–Ω—ã–π —Å–µ—Ä–≤–µ—Ä –∫–æ–º–ø–∞–Ω–∏–∏ –ø–æ–º–∏—Ä–∞–µ—Ç —É–∂–µ **—Å–µ–π—á–∞—Å**.
3. –ì—Ä—É–ø–ø–∞ –¥—Ä—É–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª–µ–π –∞–∫—Ç–∏–≤–Ω–æ —Ä–∞–±–æ—Ç–∞–ª–∞ –Ω–∞–¥ —ç—Ç–æ–π –±–∏–±–ª–∏–æ—Ç–µ–∫–æ–π, —Ä–µ–∞–ª–∏–∑—É—è —É–ª—É—á—à–µ–Ω–Ω—ã–µ –∞–ª–≥–æ—Ä–∏—Ç–º—ã –∏ –ø—Ä–æ–≤–æ–¥—è –º–Ω–æ–∂–µ—Å—Ç–≤–æ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–æ–≤. –ò—Ö –Ω–µ –æ—á–µ–Ω—å –ø–æ—Ä–∞–¥—É–µ—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å –∏–∑—É—á–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ —è–∑—ã–∫–∞ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è, –æ–∂–∏–¥–∞–Ω–∏—è –∫–æ–º–ø–∏–ª—è—Ü–∏–∏ –∏ –±–æ—Ä—å–±—ã —Å borrow checker. –û–Ω–∏ –±—É–¥—É—Ç –ø—Ä–∏–∑–Ω–∞—Ç–µ–ª—å–Ω—ã, –µ—Å–ª–∏ –º—ã –Ω–µ —Å—Ç–∞–Ω–µ–º —Ç–∞–∫ —É—Å–ª–æ–∂–Ω—è—Ç—å –∏—Ö —Ä–∞–±–æ—Ç—É.

  

‚ñç –≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∏—Ä—É–µ–º
------------------

  

–ù–∞—Å—Ç–∞–ª–æ –≤—Ä–µ–º—è –¥–æ–±–∞–≤–∏—Ç—å –Ω–∞—à–µ–≥–æ –¥—Ä—É–≥–∞ ‚Äî –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤—â–∏–∫.  

  

Python –∏–º–µ–µ—Ç –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤—â–∏–∫ (`cProfile`), –Ω–æ –≤ –¥–∞–Ω–Ω–æ–º —Å–ª—É—á–∞–µ —ç—Ç–æ –Ω–µ–ø–æ–¥—Ö–æ–¥—è—â–∏–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è —Ä–∞–±–æ—Ç—ã:  

  

1. –û–Ω –Ω–∞–≤–µ—Å–∏—Ç –±–æ–ª—å—à—É—é —Ç—Ä–∞—Ç—É —Ä–µ—Å—É—Ä—Å–æ–≤ –Ω–∞ –≤–µ—Å—å –∫–æ–¥ –Ω–∞ Python, –Ω–æ –Ω–µ —É–≤–µ–ª–∏—á–∏—Ç –Ω–∞–≥—Ä—É–∑–∫—É –Ω–∞ –Ω–∞—Ç–∏–≤–Ω—ã–π –∫–æ–¥, –ø–æ—ç—Ç–æ–º—É —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –º–æ–≥—É—Ç –æ–∫–∞–∑–∞—Ç—å—Å—è –∏—Å–∫–∞–∂—ë–Ω–Ω—ã–º–∏.
2. –ú—ã –Ω–µ —Å–º–æ–∂–µ–º –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å –Ω–∞—Ç–∏–≤–Ω—ã–µ –∫–∞–¥—Ä—ã, —Ç–æ –µ—Å—Ç—å –Ω–µ —Å–º–æ–∂–µ–º –∑–∞–≥–ª—è–Ω—É—Ç—å –≤ –Ω–∞—à –∫–æ–¥ –Ω–∞ Rust.

  

–ú—ã –±—É–¥–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `py-spy` ([GitHub](https://github.com/benfred/py-spy)).  

  

`py-spy` ‚Äî —ç—Ç–æ [—Å—ç–º–ø–ª–∏—Ä—É—é—â–∏–π –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤—â–∏–∫](https://en.wikipedia.org/wiki/Profiling_(computer_programming)#Statistical_profilers), —Å–ø–æ—Å–æ–±–Ω—ã–π –∑–∞–≥–ª—è–¥—ã–≤–∞—Ç—å –≤ –Ω–∞—Ç–∏–≤–Ω—ã–µ –∫–∞–¥—Ä—ã.  

  

–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Ç–∞–∫–∂–µ –ª—é–±–µ–∑–Ω–æ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–ª–∏ –≥–æ—Ç–æ–≤—ã–µ wheel –¥–ª—è pypi, –ø–æ—ç—Ç–æ–º—É –º–æ–∂–Ω–æ –ø—Ä–æ—Å—Ç–æ –≤–≤–µ—Å—Ç–∏ `pip install py-spy` –∏ –ø—Ä–∏—Å—Ç—É–ø–∞—Ç—å –∫ —Ä–∞–±–æ—Ç–µ.  

  

–ï—â—ë –Ω–∞–º –Ω—É–∂–Ω–æ —á—Ç–æ-—Ç–æ –¥–ª—è –∏–∑–º–µ—Ä–µ–Ω–∏–π.  

  


```
# measure.py
import time
import poly_match
import os
 
# –°–Ω–∏–∂–∞–µ–º —à—É–º, –≤ –Ω–∞—à–µ–º —Å–ª—É—á–∞–µ –ø–æ–≤—ã—à–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å.
os.environ["OPENBLAS_NUM_THREADS"] = "1"

polygons, points = poly_match.generate_example()

# –ú—ã –±—É–¥–µ–º —É–≤–µ–ª–∏—á–∏–≤–∞—Ç—å —ç—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ, –∫–æ–≥–¥–∞ –Ω–∞—à –∫–æ–¥ –±—É–¥–µ—Ç —Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è –≤—Å—ë –±—ã—Å—Ç—Ä–µ–µ –∏ –±—ã—Å—Ç—Ä–µ–µ.
NUM_ITER = 10

t0 = time.perf_counter()
for _ in range(NUM_ITER):
    poly_match.main(polygons, points)
t1 = time.perf_counter()

took = (t1 - t0) / NUM_ITER
print(f"Took and avg of {took * 1000:.2f}ms per iteration")
```
  

–í—ã–≥–ª—è–¥–∏—Ç –Ω–µ –æ—á–µ–Ω—å –Ω–∞—É—á–Ω–æ, –Ω–æ –ø–æ–∑–≤–æ–ª–∏—Ç –Ω–∞–º —Å–¥–µ–ª–∞—Ç—å *–æ–≥—Ä–æ–º–Ω—ã–π* —à–∞–≥ –≤–ø–µ—Ä—ë–¥.  

  


> ¬´–•–æ—Ä–æ—à–∏–π –±–µ–Ω—á–º–∞—Ä–∫–∏–Ω–≥ ‚Äî —ç—Ç–æ —Å–ª–æ–∂–Ω–æ. –¢–µ–º –Ω–µ –º–µ–Ω–µ–µ ‚Äî –Ω–µ —Å–ª–∏—à–∫–æ–º –Ω–∞–ª–µ–≥–∞–π—Ç–µ –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–µ –∏–¥–µ–∞–ª—å–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã –±–µ–Ω—á–º–∞—Ä–∫–∏–Ω–≥–∞, –æ—Å–æ–±–µ–Ω–Ω–æ –∫–æ–≥–¥–∞ –≤—ã –Ω–∞—á–∏–Ω–∞–µ—Ç–µ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º—É¬ª. ~ –ù–∏–∫–æ–ª–∞—Å –ù–µ—Ç–µ—Ä–∫–æ—Ç, [¬´The Rust Performance Book¬ª](https://nnethercote.github.io/perf-book/benchmarking.html)

  

–ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —ç—Ç–æ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞ –º—ã –ø–æ–ª—É—á–∏–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã, –æ—Ç –∫–æ—Ç–æ—Ä—ã—Ö –º–æ–∂–Ω–æ –æ—Ç—Ç–∞–ª–∫–∏–≤–∞—Ç—å—Å—è:  

  


```
$ python measure.py
Took an avg of 293.41ms per iteration
```
  

–î–ª—è –Ω–∞—à–µ–π –Ω–∞—Å—Ç–æ—è—â–µ–π –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –º—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ 50 —Ä–∞–∑–Ω—ã—Ö —Å–ª—É—á–∞–µ–≤, —á—Ç–æ–±—ã –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–∫—Ä—ã—Ç–∏–µ –≤—Å–µ—Ö —Å–ª—É—á–∞–µ–≤.  

  

–≠—Ç–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞–ª–æ –æ–±—â–µ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ —Å–∏—Å—Ç–µ–º—ã, —Ç–æ –µ—Å—Ç—å –º—ã –º–æ–≥–ª–∏ –ø—Ä–∏—Å—Ç—É–ø–∞—Ç—å –∫ –±–æ—Ä—å–±–µ —Å —ç—Ç–∏–º–∏ —á–∏—Å–ª–∞–º–∏.  

  

–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: –º–æ–∂–Ω–æ —Ç–∞–∫–∂–µ –≤—ã–ø–æ–ª–Ω—è—Ç—å –∏–∑–º–µ—Ä–µ–Ω–∏—è –ø—Ä–∏ –ø–æ–º–æ—â–∏ PyPy (—Ç–∞–∫–∂–µ –º—ã –¥–æ–±–∞–≤–∏–º —Ä–∞–∑–æ–≥—Ä–µ–≤, —á—Ç–æ–±—ã JIT –ø–æ–∫–∞–∑–∞–ª–∞ —Å–≤–æ—é –º–∞–≥–∏—é).  

  


```
$ conda create -n pypyenv -c conda-forge pypy numpy && conda activate pypyenv
$ pypy measure_with_warmup.py
Took an avg of 1495.81ms per iteration
```
  

‚ñç –ò–∑–º–µ—Ä–µ–Ω–∏—è ‚Äî —ç—Ç–æ –≥–ª–∞–≤–Ω–æ–µ
-------------------------

  

–¢–∞–∫, –¥–∞–≤–∞–π—Ç–µ –≤—ã—è—Å–Ω–∏–º, —á—Ç–æ –∂–µ —Ç—É—Ç —Ç–∞–∫ –º–µ–¥–ª–µ–Ω–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç.  

  


```
$ py-spy record --native -o profile.svg -- python measure.py
py-spy> Sampling process 100 times a second. Press Control-C to exit.

Took an avg of 365.43ms per iteration

py-spy> Stopped sampling because process exited
py-spy> Wrote flamegraph data to 'profile.svg'. Samples: 391 Errors: 0
```
  

–ú—ã —É–∂–µ –≤–∏–¥–∏–º, —á—Ç–æ –ª–∏—à–Ω—è—è —Ç—Ä–∞—Ç–∞ —Ä–µ—Å—É—Ä—Å–æ–≤ —Ç—É—Ç –¥–æ–≤–æ–ª—å–Ω–æ –º–∞–ª–∞. –ü—Ä–æ—Å—Ç–æ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è, –ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ `cProfile` –º—ã –ø–æ–ª—É—á–∏–º —Å–ª–µ–¥—É—é—â–µ–µ:  

  


```
$ python -m cProfile measure.py
Took an avg of 546.47ms per iteration
         7551778 function calls (7409483 primitive calls) in 7.806 seconds
         ...
```
  

–ú—ã –ø–æ–ª—É—á–∞–µ–º –≤–æ—Ç —Ç–∞–∫–æ–π –∫—Ä–∞—Å–∏–≤—ã–π –∫—Ä–∞—Å–Ω—ã–π –≥—Ä–∞—Ñ–∏–∫, –Ω–∞–∑—ã–≤–∞–µ–º—ã–π [flamegraph](https://www.brendangregg.com/FlameGraphs/cpuflamegraphs.html):  

  

![](https://habrastorage.org/r/w1560/webt/u4/3m/oz/u43mozwgcnf8hw5_rj5hducg1a0.png)  

–ö–∞–∂–¥—ã–π –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫ ‚Äî —ç—Ç–æ —Ñ—É–Ω–∫—Ü–∏—è. –í –æ—Ä–∏–≥–∏–Ω–∞–ª–µ —Å—Ç–∞—Ç—å–∏ [–≥—Ä–∞—Ñ–∏–∫ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–µ–Ω](https://ohadravid.github.io/posts/2023-03-rusty-python/#measure-first) –∏ –º—ã –º–æ–∂–µ–º –≤–∏–¥–µ—Ç—å –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ–µ –≤—Ä–µ–º—è, –ø—Ä–æ–≤–æ–¥–∏–º–æ–µ –≤ –∫–∞–∂–¥–æ–π —Ñ—É–Ω–∫—Ü–∏–∏, –≤ —Ç–æ–º —á–∏—Å–ª–µ –≤ —Ñ—É–Ω–∫—Ü–∏—è—Ö, –∫–æ—Ç–æ—Ä—ã–µ –æ–Ω–∞ –≤—ã–∑—ã–≤–∞–µ—Ç (—Å–ø—É—Å–∫–∞—è—Å—å –≤–Ω–∏–∑ –ø–æ –≥—Ä–∞—Ñ–∏–∫—É/—Å—Ç–µ–∫—É). –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –Ω–∞–∂–∞—Ç—å –Ω–∞ –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫ `norm`, —á—Ç–æ–±—ã –ø—Ä–∏–±–ª–∏–∑–∏—Ç—å –µ–≥–æ.  

  

–ó–¥–µ—Å—å –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å —Å–ª–µ–¥—É—é—â–∏–µ –æ—Å–Ω–æ–≤–Ω—ã–µ –≤—ã–≤–æ–¥—ã:  

  

1. –ü–æ–¥–∞–≤–ª—è—é—â–µ–µ –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ –≤—Ä–µ–º–µ–Ω–∏ —Ç—Ä–∞—Ç–∏—Ç—Å—è –≤ `find_close_polygons`.
2. –û—Å–Ω–æ–≤–Ω–∞—è —á–∞—Å—Ç—å —ç—Ç–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ —Ç—Ä–∞—Ç–∏—Ç—Å—è –Ω–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ `norm`, –∫–æ—Ç–æ—Ä–∞—è —è–≤–ª—è–µ—Ç—Å—è —Ñ—É–Ω–∫—Ü–∏–µ–π numpy.

  

–ò—Ç–∞–∫, –¥–∞–≤–∞–π—Ç–µ –≤–∑–≥–ª—è–Ω–µ–º –Ω–∞ `find_close_polygons`:  

  


```
def find_close_polygons(
    polygon_subset: List[Polygon], point: np.array, max_dist: float
) -> List[Polygon]:
    close_polygons = []
    for poly in polygon_subset:
        if np.linalg.norm(poly.center - point) < max_dist:
            close_polygons.append(poly)

    return close_polygons
```
  

–ú—ã –ø–µ—Ä–µ–ø–∏—à–µ–º —ç—Ç—É —Ñ—É–Ω–∫—Ü–∏—é –Ω–∞ Rust.  

  

–ü—Ä–µ–∂–¥–µ —á–µ–º –≤–¥–∞–≤–∞—Ç—å—Å—è –≤ –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏, –≤–∞–∂–Ω–æ –∑–∞–º–µ—Ç–∏—Ç—å –∑–¥–µ—Å—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–æ–º–µ–Ω—Ç–æ–≤:  

  

1. –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ª–æ–∂–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã (`Polygon`, `np.array`).
2. –†–∞–∑–º–µ—Ä –æ–±—ä–µ–∫—Ç–æ–≤ –Ω–µ—Ç—Ä–∏–≤–∏–∞–ª–µ–Ω (–ø–æ—ç—Ç–æ–º—É –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –∑–∞—Ç—Ä–∞—Ç–Ω—ã–º).
3. –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è —á–∞—Å—Ç–æ (–ø–æ—ç—Ç–æ–º—É –≤–Ω–µ—Å—ë–Ω–Ω–∞—è –Ω–∞–º–∏ –ª–∏—à–Ω—è—è —Ç—Ä–∞—Ç–∞ —Ä–µ—Å—É—Ä—Å–æ–≤, –≤–µ—Ä–æ—è—Ç–Ω–æ, –±—É–¥–µ—Ç –∏–º–µ—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ).

  

‚ñç –ú–æ–π –ø–µ—Ä–≤—ã–π –º–æ–¥—É–ª—å Rust
------------------------

  

`pyo3` ‚Äî —ç—Ç–æ –∫—Ä–µ–π—Ç –¥–ª—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è –º–µ–∂–¥—É Python –∏ Rust. –û–Ω –∏–º–µ–µ—Ç —á—Ä–µ–∑–≤—ã—á–∞–π–Ω–æ —Ö–æ—Ä–æ—à—É—é –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é, –∞ –±–∞–∑–æ–≤–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—ä—è—Å–Ω–µ–Ω–∞ [–∑–¥–µ—Å—å](https://pyo3.rs/v0.18.1/#using-rust-from-python).  

  

–ú—ã –Ω–∞–∑–æ–≤—ë–º —Å–≤–æ–π –∫—Ä–µ–π—Ç `poly_match_rs` –∏ –¥–æ–±–∞–≤–∏–º —Ñ—É–Ω–∫—Ü–∏—é `find_close_polygons`.  

  


```
mkdir poly_match_rs && cd "$_"
pip install maturin
maturin init --bindings pyo3
maturin develop
```
  

–ò–∑–Ω–∞—á–∞–ª—å–Ω–æ –Ω–∞—à –∫—Ä–µ–π—Ç –±—É–¥–µ—Ç –≤—ã–≥–ª—è–¥–µ—Ç—å —Ç–∞–∫:  

  


```
use pyo3::prelude::*;

#[pyfunction]
fn find_close_polygons() -> PyResult<()> {
    Ok(())
}

#[pymodule]
fn poly_match_rs(_py: Python, m: &PyModule) -> PyResult<()> {
    m.add_function(wrap_pyfunction!(find_close_polygons, m)?)?;
    Ok(())
}
```
  

–ù–∞–º —Ç–∞–∫–∂–µ –Ω—É–∂–Ω–æ –Ω–µ –∑–∞–±—ã–≤–∞—Ç—å –≤—ã–ø–æ–ª–Ω—è—Ç—å `maturin develop` –∫–∞–∂–¥—ã–π —Ä–∞–∑, –∫–æ–≥–¥–∞ –º—ã –º–µ–Ω—è–µ–º –±–∏–±–ª–∏–æ—Ç–µ–∫—É Rust.  

  

–í–æ—Ç –∏ –≤—Å—ë! –î–∞–≤–∞–π—Ç–µ –≤—ã–∑–æ–≤–µ–º –Ω–∞—à—É –Ω–æ–≤—É—é —Ñ—É–Ω–∫—Ü–∏—é –∏ –ø–æ—Å–º–æ—Ç—Ä–∏–º, —á—Ç–æ –ø—Ä–æ–∏–∑–æ–π–¥—ë—Ç.  

  


```
>>> poly_match_rs.find_close_polygons(polygons, point, max_dist)
E TypeError: poly_match_rs.poly_match_rs.find_close_polygons() takes no arguments (3 given)
```
  

‚ñç v1 ‚Äî –Ω–∞–∏–≤–Ω–∞—è —Ç—Ä–∞–Ω—Å–ª—è—Ü–∏—è Rust
------------------------------

  

–ù–∞—á–Ω—ë–º –º—ã —Å —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è –æ–∂–∏–¥–∞–µ–º–æ–≥–æ API.  

  

PyO3 –¥–æ–≤–æ–ª—å–Ω–æ —Å–æ–æ–±—Ä–∞–∑–∏—Ç–µ–ª–µ–Ω –ø—Ä–∏ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è—Ö –∏–∑ Python –≤ Rust, –ø–æ—ç—Ç–æ–º—É —ç—Ç–æ –±—É–¥–µ—Ç –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–æ—Å—Ç–æ:  

  


```
#[pyfunction]
fn find_close_polygons(polygons: Vec<PyObject>, point: PyObject, max_dist: f64) -> PyResult<Vec<PyObject>> {
    Ok(vec![])
}
```
  

`PyObject` ‚Äî —ç—Ç–æ (–∫–∞–∫ –ø–æ–Ω—è—Ç–Ω–æ –∏–∑ –∏–º–µ–Ω–∏) –æ–±–æ–±—â—ë–Ω–Ω—ã–π –æ–±—ä–µ–∫—Ç Python. –ú—ã –ø–æ–ø—Ä–æ–±—É–µ–º –Ω–µ–º–Ω–æ–≥–æ –ø–æ–≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å —Å –Ω–∏–º.  

  

–≠—Ç–æ –¥–æ–ª–∂–Ω–æ –∑–∞—Å—Ç–∞–≤–∏—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º—É –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è (—Ö–æ—Ç—å –∏ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ).  

  

–Ø –ø—Ä–æ—Å—Ç–æ —Å–∫–æ–ø–∏—Ä—É—é –∏ –≤—Å—Ç–∞–≤–ª—é –∏—Å—Ö–æ–¥–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é –Ω–∞ Python, –∞ –ø–æ—Ç–æ–º –∏—Å–ø—Ä–∞–≤–ª—é —Å–∏–Ω—Ç–∞–∫—Å–∏—Å.  

  


```
#[pyfunction]
fn find_close_polygons(polygons: Vec<PyObject>, point: PyObject, max_dist: f64) -> PyResult<Vec<PyObject>> {
    let mut close_polygons = vec![];
    
    for poly in polygons {
        if norm(poly.center - point) < max_dist {
            close_polygons.push(poly)
        }
    }
    
    Ok(close_polygons)
}
```
  

–ó–¥–æ—Ä–æ–≤–æ, –Ω–æ —ç—Ç–æ –Ω–µ –∫–æ–º–ø–∏–ª–∏—Ä—É–µ—Ç—Å—è:  

  


```
% maturin develop
...

error[E0609]: no field `center` on type `Py<PyAny>`
 --> src/lib.rs:8:22
  |
8 |         if norm(poly.center - point) < max_dist {
  |                      ^^^^^^ unknown field


error[E0425]: cannot find function `norm` in this scope
 --> src/lib.rs:8:12
  |
8 |         if norm(poly.center - point) < max_dist {
  |            ^^^^ not found in this scope


error: aborting due to 2 previous errors ] 58/59: poly_match_rs
```
  

–î–ª—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —ç—Ç–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞–º –ø–æ—Ç—Ä–µ–±—É—é—Ç—Å—è —Ç—Ä–∏ –∫—Ä–µ–π—Ç–∞:  

  


```
# –î–ª—è –Ω–∞—Ç–∏–≤–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π —Å –º–∞—Å—Å–∏–≤–∞–º–∏ Rust.
ndarray = "0.15"

# –î–ª—è —Ñ—É–Ω–∫—Ü–∏–∏ "norm" –¥–ª—è –º–∞—Å—Å–∏–≤–æ–≤.
ndarray-linalg = "0.16"  

# –î–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ —Å–æ–∑–¥–∞–Ω–Ω—ã–º numpy –æ–±—ä–µ–∫—Ç–∞–º, –æ—Å–Ω–æ–≤–∞–Ω–Ω—ã–º –Ω–∞ "ndarray".
numpy = "0.18"
```
  

–î–ª—è –Ω–∞—á–∞–ª–∞ –¥–∞–≤–∞–π—Ç–µ –ø—Ä–µ–≤—Ä–∞—Ç–∏–º –Ω–µ–ø—Ä–æ–∑—Ä–∞—á–Ω—É—é –∏ –æ–±–æ–±—â—ë–Ω–Ω—É—é `point: PyObject` –≤–æ —á—Ç–æ-—Ç–æ, —Å —á–µ–º –º—ã —Å–º–æ–∂–µ–º —Ä–∞–±–æ—Ç–∞—Ç—å.  

  

–¢–æ—á–Ω–æ —Ç–∞–∫ –∂–µ, –∫–∞–∫ –º—ã –ø–æ–ø—Ä–æ—Å–∏–ª–∏ —É PyO3 `Vec` –æ–±—ä–µ–∫—Ç–∞ `PyObject`, –º—ã –º–æ–∂–µ–º –ø–æ–ø—Ä–æ—Å–∏—Ç—å numpy-array, –∏ –æ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç –∞—Ä–≥—É–º–µ–Ω—Ç.  

  


```
use numpy::PyReadonlyArray1;

#[pyfunction]
fn find_close_polygons(
    // –û–±—ä–µ–∫—Ç, –≥–æ–≤–æ—Ä—è—â–∏–π "–£ –º–µ–Ω—è –µ—Å—Ç—å GIL", —á—Ç–æ–±—ã –º—ã –º–æ–≥–ª–∏ –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ —É–ø—Ä–∞–≤–ª—è–µ–º–æ–π Python –ø–∞–º—è—Ç–∏.
    py: Python<'_>,
    polygons: Vec<PyObject>,
    // –°—Å—ã–ª–∫–∞ –Ω–∞ –º–∞—Å—Å–∏–≤ numpy, –¥–æ—Å—Ç—É–ø –∫ –∫–æ—Ç–æ—Ä–æ–π –º—ã —Å–º–æ–∂–µ–º –∏–º–µ—Ç—å.
    point: PyReadonlyArray1<f64>,
    max_dist: f64,
) -> PyResult<Vec<PyObject>> {
    // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ –ø–æ–ª–Ω–æ—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –Ω–∞—Ç–∏–≤–Ω—ã–π –º–∞—Å—Å–∏–≤ "ndarray::ArrayView1".
    let point = point.as_array();
    ...
}
```
  

–¢–∞–∫ –∫–∞–∫ —Ç–æ—á–∫–∞ —Ç–µ–ø–µ—Ä—å –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ ArrayView1, –º—ã –º–æ–∂–µ–º –µ—ë –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å. –ù–∞–ø—Ä–∏–º–µ—Ä:  

  


```
// –¥–µ–ª–∞–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏—é "norm".
use ndarray_linalg::Norm;

assert_eq!((point.to_owned() - point).norm(), 0.);
```
  

–¢–µ–ø–µ—Ä—å –Ω–∞–º –ø—Ä–æ—Å—Ç–æ –Ω—É–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å —Ü–µ–Ω—Ç—Ä –∫–∞–∂–¥–æ–≥–æ –º–Ω–æ–≥–æ—É–≥–æ–ª—å–Ω–∏–∫–∞ –∏ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å –µ–≥–æ –≤ `ArrayView1`.  

  

–ù–∞ PyO3 —ç—Ç–æ –≤—ã–≥–ª—è–¥–∏—Ç —Ç–∞–∫:  

  


```
let center = poly
  .getattr(py, "center")?                 // getattr –≤ —Å—Ç–∏–ª–µ Python, —Ç—Ä–µ–±—É–µ—Ç —Ç–æ–∫–µ–Ω GIL (`py`).
  .extract::<PyReadonlyArray1<f64>>(py)?  // –°–æ–æ–±—â–∞–µ–º PyO3, –≤–æ —á—Ç–æ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç.
  .as_array()                             // –ö–∞–∫ "point" —Ä–∞–Ω–µ–µ.
  .to_owned();                            // –ù–∞–º –Ω—É–∂–Ω–æ, —á—Ç–æ–±—ã –æ–¥–Ω–æ–π –∏–∑ —Å—Ç–æ—Ä–æ–Ω `-` "–≤–ª–∞–¥–µ–ª–∏".
```
  

–°–ª–µ–≥–∫–∞ –º–Ω–æ–≥–æ—Å–ª–æ–≤–Ω–æ, –Ω–æ –≤ —Ü–µ–ª–æ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç, –æ—á–µ–≤–∏–¥–Ω–æ, —è–≤–ª—è–µ—Ç—Å—è –ø–æ—Å—Ç—Ä–æ—á–Ω–æ–π —Ç—Ä–∞–Ω—Å–ª—è—Ü–∏–µ–π –ø–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–æ–≥–æ –∫–æ–¥–∞:  

  


```
use pyo3::prelude::*;

use ndarray_linalg::Norm;
use numpy::PyReadonlyArray1;

#[pyfunction]
fn find_close_polygons(
    py: Python<'_>,
    polygons: Vec<PyObject>,
    point: PyReadonlyArray1<f64>,
    max_dist: f64,
) -> PyResult<Vec<PyObject>> {
    let mut close_polygons = vec![];
    let point = point.as_array();
    for poly in polygons {
        let center = poly
            .getattr(py, "center")?
            .extract::<PyReadonlyArray1<f64>>(py)?
            .as_array()
            .to_owned();

        if (center - point).norm() < max_dist {
            close_polygons.push(poly)
        }
    }

    Ok(close_polygons)
}
```
  

–°—Ä–∞–≤–Ω–∏–º —Å –æ—Ä–∏–≥–∏–Ω–∞–ª–æ–º:  

  


```
def find_close_polygons(
    polygon_subset: List[Polygon], point: np.array, max_dist: float
) -> List[Polygon]:
    close_polygons = []
    for poly in polygon_subset:
        if np.linalg.norm(poly.center - point) < max_dist:
            close_polygons.append(poly)

    return close_polygons
```
  

–ú—ã –æ–∂–∏–¥–∞–µ–º, —á—Ç–æ —ç—Ç–∞ –≤–µ—Ä—Å–∏—è –±—É–¥–µ—Ç –∏–º–µ—Ç—å –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –ø–µ—Ä–µ–¥ –∏—Å—Ö–æ–¥–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–µ–π, –Ω–æ –Ω–∞—Å–∫–æ–ª—å–∫–æ?  

  


```
$ (cd ./poly_match_rs/ && maturin develop)
$ python measure.py
Took an avg of 609.46ms per iteration
```
  

–¢–æ –µ—Å—Ç—å‚Ä¶ Rust –æ—á–µ–Ω—å –º–µ–¥–ª–µ–Ω–Ω—ã–π? –ù–µ—Ç! –ú—ã –ø—Ä–æ—Å—Ç–æ –∑–∞–±—ã–ª–∏ —É–∑–Ω–∞—Ç—å —Å–∫–æ—Ä–æ—Å—Ç—å! –ï—Å–ª–∏ –∑–∞–ø—É—Å—Ç–∏–º –∫–æ–¥ —Å `maturin develop --release`, —Ç–æ –ø–æ–ª—É—á–∏–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≥–æ—Ä–∞–∑–¥–æ –ª—É—á—à–µ:  

  


```
$ (cd ./poly_match_rs/ && maturin develop --release)
$ python measure.py
Took an avg of 23.44ms per iteration
```
  

–ê –≤–æ—Ç *—ç—Ç–æ* —É–∂–µ —Ö–æ—Ä–æ—à–µ–µ —É—Å–∫–æ—Ä–µ–Ω–∏–µ!  

  

–¢–∞–∫–∂–µ –º—ã —Ö–æ—Ç–∏–º –∏–º–µ—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∑–∞–≥–ª—è–¥—ã–≤–∞—Ç—å –≤ –Ω–∞—Ç–∏–≤–Ω—ã–π –∫–æ–¥, –ø–æ—ç—Ç–æ–º—É –≤–∫–ª—é—á–∏–º –æ—Ç–ª–∞–¥–æ—á–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã –≤ —Ä–µ–ª–∏–∑–µ. –ò –∑–∞–æ–¥–Ω–æ —Å–ø—Ä–æ—Å–∏–º *–º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é —Å–∫–æ—Ä–æ—Å—Ç—å*.  

  


```
# added to Cargo.toml
[profile.release]
debug = true       # –û—Ç–ª–∞–¥–æ—á–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã –¥–ª—è –Ω–∞—à–µ–≥–æ –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤—â–∏–∫–∞.
lto = true         # –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —ç—Ç–∞–ø–∞ –∫–æ–º–ø–æ–Ω–æ–≤–∫–∏.
codegen-units = 1  # –ë–æ–ª–µ–µ –º–µ–¥–ª–µ–Ω–Ω–∞—è –∫–æ–º–ø–∏–ª—è—Ü–∏—è, –∑–∞—Ç–æ –±–æ–ª–µ–µ –±—ã—Å—Ç—Ä—ã–π –∫–æ–¥. 
```
  

‚ñç v2 ‚Äî –ø–µ—Ä–µ–ø–∏—à–µ–º –µ—â—ë –±–æ–ª—å—à–µ –Ω–∞ Rust
-----------------------------------

  

–¢–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–≤ —Ñ–ª–∞–≥ `--native` –≤ `py-spy`, –º—ã —Å–º–æ–∂–µ–º –≤–∏–¥–µ—Ç—å –∏ Python, –∏ –Ω–∞—à –Ω–æ–≤—ã–π –Ω–∞—Ç–∏–≤–Ω—ã–π –∫–æ–¥.  

  

–°–Ω–æ–≤–∞ –∑–∞–ø—É—Å–∫–∞–µ–º `py-spy`:  

  


```
$ py-spy record --native -o profile.svg -- python measure.py
py-spy> Sampling process 100 times a second. Press Control-C to exit.
```
  

–ü–æ–ª—É—á–∞–µ–º —Ç–∞–∫–æ–π flamegraph (–Ω–µ–∫—Ä–∞—Å–Ω—ã–µ —Ü–≤–µ—Ç–∞ –¥–æ–±–∞–≤–ª–µ–Ω—ã –¥–ª—è —Ç–æ–≥–æ, —á—Ç–æ–±—ã –º—ã –º–æ–≥–ª–∏ –æ—Ç—Ç–∞–ª–∫–∏–≤–∞—Ç—å—Å—è –æ—Ç –Ω–∏—Ö):  

  

![](https://habrastorage.org/r/w1560/webt/h7/0k/bp/h70kbpauzzyg6fpuvbjhgiyi-90.png)*–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—É—é –≤–µ—Ä—Å–∏—é –º–æ–∂–Ω–æ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å [–∑–¥–µ—Å—å](https://ohadravid.github.io/posts/2023-03-rusty-python/#v2---rewrite-even-more-in-rust)*  

  

–ü–æ—Å–º–æ—Ç—Ä–µ–≤ –Ω–∞ –≤—ã–≤–æ–¥ –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤—â–∏–∫–∞, –º—ã –º–æ–∂–µ–º –∑–∞–º–µ—Ç–∏—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã—Ö –º–æ–º–µ–Ω—Ç–æ–≤:  

  

1. –û—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä `find_close_polygons::...::trampoline` (—Å–∏–º–≤–æ–ª–∞, –∫–æ—Ç–æ—Ä—ã–π Python –Ω–µ–ø–æ—Å—Ä–µ–¥—Å—Ç–≤–µ–Ω–Ω–æ –≤—ã–∑—ã–≤–∞–µ—Ç) –∏ `__pyfunction_find_close_polygons` (–Ω–∞—à–µ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏).
	* –ï—Å–ª–∏ –Ω–∞–≤–µ—Å—Ç–∏ –º—ã—à—å, –≤–∏–¥–Ω–æ, —á—Ç–æ —Å—ç–º–ø–ª—ã —Å–æ–æ—Ç–Ω–æ—Å—è—Ç—Å—è –∫–∞–∫ 95% –∏ 88%, —Ç–æ –µ—Å—Ç—å –ª–∏—à–Ω—è—è —Ç—Ä–∞—Ç–∞ —Ä–µ—Å—É—Ä—Å–æ–≤ –¥–æ–≤–æ–ª—å–Ω–æ –º–∞–ª–∞.
2. –°–∞–º–∞ –ª–æ–≥–∏–∫–∞ (`if (center - point).norm() < max_dist { ... }`), –∫–æ—Ç–æ—Ä–∞—è –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ `lib_v1.rs:22` (–æ—á–µ–Ω—å –º–∞–ª–µ–Ω—å–∫–∏–π –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫ —Å–ø—Ä–∞–≤–∞), –∑–∞–Ω–∏–º–∞–µ—Ç –ø—Ä–∏–º–µ—Ä–Ω–æ 9% –æ—Ç –≤—Å–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è.
	* –¢–æ –µ—Å—Ç—å —É–ª—É—á—à–µ–Ω–∏–µ –≤ –¥–µ—Å—è—Ç—å —Ä–∞–∑ –≤—Å—ë —Ä–∞–≤–Ω–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ!
3. –û—Å–Ω–æ–≤–Ω–∞—è —á–∞—Å—Ç—å –≤—Ä–µ–º–µ–Ω–∏ —Ç—Ä–∞—Ç–∏—Ç—Å—è –Ω–∞ `lib_v1.rs:16`, —Ç–æ –µ—Å—Ç—å –Ω–∞ `poly.getattr(...).extract(...)`, –∏ –µ—Å–ª–∏ –º—ã –ø—Ä–∏–±–ª–∏–∑–∏–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ, —Ç–æ —É–≤–∏–¥–∏–º, —á—Ç–æ –Ω–∞ —Å–∞–º–æ–º –¥–µ–ª–µ —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ `getattr` –∏ –ø–æ–ª—É—á–µ–Ω–∏–µ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ –º–∞—Å—Å–∏–≤–∞ –ø—Ä–∏ –ø–æ–º–æ—â–∏ `as_array`.

  

–ú–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –≤—ã–≤–æ–¥, —á—Ç–æ –Ω–∞–º –Ω—É–∂–Ω–æ —Å–æ—Å—Ä–µ–¥–æ—Ç–æ—á–∏—Ç—å—Å—è –Ω–∞ —Ä–µ—à–µ–Ω–∏–∏ —Ç—Ä–µ—Ç—å–µ–≥–æ –ø—É–Ω–∫—Ç–∞, –∏ —Å–¥–µ–ª–∞—Ç—å —ç—Ç–æ –º–æ–∂–Ω–æ –ü–µ—Ä–µ–ø–∏—Å–∞–≤ `Polygon` –Ω–∞ Rust.  

  

–î–∞–≤–∞–π—Ç–µ –≤–∑–≥–ª—è–Ω–µ–º –Ω–∞ –Ω–∞—à—É —Ü–µ–ª—å:  

  


```
@dataclass
class Polygon:
    x: np.array
    y: np.array
    _area: float = None

    @cached_property
    def center(self) -> np.array:
        centroid = np.array([self.x, self.y]).mean(axis=1)
        return centroid

    def area(self) -> float:
        if self._area is None:
            self._area = 0.5 * np.abs(
                np.dot(self.x, np.roll(self.y, 1)) - np.dot(self.y, np.roll(self.x, 1))
            )
        return self._area
```
  

–ù–∞–º –Ω—É–∂–Ω–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–º–µ—é—â–∏–π—Å—è API, –Ω–æ –Ω–∞–º –Ω–µ –Ω—É–∂–Ω–æ (–ø–æ–∫–∞), —á—Ç–æ–±—ã `area` –±—ã–ª–∞ —Ç–∞–∫–æ–π —É–∂ –±—ã—Å—Ç—Ä–æ–π.  

  

–°–∞–º –∫–ª–∞—Å—Å –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å–ª–æ–∂–Ω—ã–µ –≤–µ—â–∏, –Ω–∞–ø—Ä–∏–º–µ—Ä, –º–µ—Ç–æ–¥ `merge`, –∏—Å–ø–æ–ª—å–∑—É—é—â–∏–π `ConvexHull` –∏–∑ `scipy.spatial`.  

  

–ß—Ç–æ–±—ã —Å–Ω–∏–∑–∏—Ç—å –∑–∞—Ç—Ä–∞—Ç—ã (–∏ –æ–≥—Ä–∞–Ω–∏—á–∏—Ç—å —Ä–∞–º–∫–∏ —ç—Ç–æ–π –∏ —Ç–∞–∫ –¥–ª–∏–Ω–Ω–æ–π —Å—Ç–∞—Ç—å–∏), –º—ã —Ç–æ–ª—å–∫–æ –ø–µ—Ä–µ–º–µ—Å—Ç–∏–º ¬´–æ—Å–Ω–æ–≤–Ω—É—é¬ª —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å `Polygon` –Ω–∞ Rust, –∏ —Å–¥–µ–ª–∞–µ–º –µ—ë –ø–æ–¥–∫–ª–∞—Å—Å–æ–º –∏–∑ Python –¥–ª—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –æ—Å—Ç–∞–ª—å–Ω–æ–≥–æ API.  

  

–ù–∞—à–∞ `struct` –±—É–¥–µ—Ç –≤—ã–≥–ª—è–¥–µ—Ç—å —Ç–∞–∫:  

  


```
// "Array1" - —ç—Ç–æ –æ–¥–Ω–æ–º–µ—Ä–Ω—ã–π –º–∞—Å—Å–∏–≤, –∏ –∫—Ä–µ–π—Ç "numpy" –±—É–¥–µ—Ç —Ö–æ—Ä–æ—à–æ —Å –Ω–∏–º –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å.
use ndarray::Array1;

// "subclass" –ø—Ä–∏–∫–∞–∑—ã–≤–∞–µ—Ç PyO3 —Ä–∞–∑—Ä–µ—à–∏—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ–¥–∫–ª–∞—Å—Å–æ–≤ —ç—Ç–æ–≥–æ –Ω–∞ Python.
#[pyclass(subclass)]
struct Polygon {
    x: Array1<f64>,
    y: Array1<f64>,
    center: Array1<f64>,
}
```
  

–ú—ã —Ö–æ—Ç–∏–º —Ä–∞—Å–∫—Ä—ã—Ç—å `poly.{x, y, center}` —Å–ª–µ–¥—É—é—â–∏–º –æ–±—Ä–∞–∑–æ–º:  

  

1. –°–≤–æ–π—Å—Ç–≤–∞.
2. –ú–∞—Å—Å–∏–≤—ã numpy.

  

–¢–∞–∫–∂–µ –Ω–∞–º –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä, —á—Ç–æ–±—ã Python –º–æ–≥ —Å–æ–∑–¥–∞–≤–∞—Ç—å –Ω–æ–≤—ã–µ `Polygon`.  

  


```
use numpy::{PyArray1, PyReadonlyArray1, ToPyArray};

#[pymethods]
impl Polygon {
    #[new]
    fn new(x: PyReadonlyArray1<f64>, y: PyReadonlyArray1<f64>) -> Polygon {
        let x = x.as_array();
        let y = y.as_array();
        let center = Array1::from_vec(vec![x.mean().unwrap(), y.mean().unwrap()]);

        Polygon {
            x: x.to_owned(),
            y: y.to_owned(),
            center,
        }
    }
    
    // "Py<..>" –≤ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º–æ–º —Ç–∏–ø–µ - —ç—Ç–æ —Å–ø–æ—Å–æ–± –ø–æ–∫–∞–∑–∞—Ç—å, —á—Ç–æ –æ–±—ä–µ–∫—Ç –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç Python".
    #[getter]               
    fn x(&self, py: Python<'_>) -> PyResult<Py<PyArray1<f64>>> {
        Ok(self.x.to_pyarray(py).to_owned()) // –°–æ–∑–¥–∞—ë–º numpy-–≤–µ—Ä—Å–∏—é "x", –∫–æ—Ç–æ—Ä–æ–π –±—É–¥–µ—Ç –≤–ª–∞–¥–µ—Ç—å Python.
    }

    // –¢–æ –∂–µ –¥–ª—è "y" –∏ "center".
}
```
  

–ú—ã –¥–æ–ª–∂–Ω—ã –¥–æ–±–∞–≤–∏—Ç—å –Ω–∞—à—É –Ω–æ–≤—É—é struct –∫–∞–∫ –∫–ª–∞—Å—Å –≤ –º–æ–¥—É–ª—å:  

  


```
#[pymodule]
fn poly_match_rs(_py: Python, m: &PyModule) -> PyResult<()> {
    m.add_class::<Polygon>()?; // new.
    m.add_function(wrap_pyfunction!(find_close_polygons, m)?)?;
    Ok(())
}
```
  

–ê —Ç–µ–ø–µ—Ä—å –º—ã –º–æ–∂–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç—å –∫–æ–¥ –Ω–∞ Python, —á—Ç–æ–±—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –µ–≥–æ:  

  


```
class Polygon(poly_match_rs.Polygon):
    _area: float = None

    def area(self) -> float:
        ...
```
  

–ú–æ–∂–Ω–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –∫–æ–º–ø–∏–ª—è—Ü–∏—é, –∏ —ç—Ç–æ –Ω–∞ —Å–∞–º–æ–º –¥–µ–ª–µ –∑–∞—Ä–∞–±–æ—Ç–∞–µ—Ç, —Ç–æ–ª—å–∫–æ –≥–æ—Ä–∞–∑–¥–æ –º–µ–¥–ª–µ–Ω–Ω–µ–µ! (–ü–æ–º–Ω–∏—Ç–µ, —á—Ç–æ `x`, `y` –∏ `center` —Ç–µ–ø–µ—Ä—å –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å –Ω–æ–≤—ã–π –º–∞—Å—Å–∏–≤ numpy **–ø—Ä–∏ –∫–∞–∂–¥–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏ –¥–æ—Å—Ç—É–ø–∞**).  

  

–ß—Ç–æ–±—ã –ø–æ–≤—ã—Å–∏—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å, –Ω–∞–º –Ω—É–∂–Ω–æ `–∏–∑–≤–ª–µ—á—å` –∏—Å—Ö–æ–¥–Ω—ã–π `Polygon` –Ω–∞ Rust –∏–∑ —Å–ø–∏—Å–∫–∞ `Polygon` Python.  

  

PyO3 –æ—á–µ–Ω—å –≥–∏–±–æ–∫ —Å —Ç–∞–∫–∏–º —Ç–∏–ø–æ–º –æ–ø–µ—Ä–∞—Ü–∏–π, –ø–æ—ç—Ç–æ–º—É –º—ã –º–æ–∂–µ–º —Å–¥–µ–ª–∞—Ç—å —ç—Ç–æ –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ —Å–ø–æ—Å–æ–±–∞–º–∏. –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∑–∞–∫–ª—é—á–∞–µ—Ç—Å—è –≤ —Ç–æ–º, —á—Ç–æ –Ω–∞–º —Ç–∞–∫–∂–µ –Ω—É–∂–Ω–æ –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å `Polygon` —è–∑—ã–∫–∞ Python –∏ –º—ã –Ω–µ —Ö–æ—Ç–∏–º –≤—ã–ø–æ–ª–Ω—è—Ç—å –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö.  

  

–ú–æ–∂–Ω–æ –≤—Ä—É—á–Ω—É—é –≤—ã–∑—ã–≤–∞—Ç—å `.extract::<Polygon>(py)?` –¥–ª—è –∫–∞–∂–¥–æ–≥–æ `PyObject`, –Ω–æ –º—ã –ø–æ–ø—Ä–æ—Å–∏–º PyO3 –¥–∞–≤–∞—Ç—å –Ω–∞–º –Ω–µ–ø–æ—Å—Ä–µ–¥—Å—Ç–≤–µ–Ω–Ω–æ `Py<Polygon>`.  

  

–≠—Ç–æ —Å—Å—ã–ª–∫–∞ –Ω–∞ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∞—â–∏–π Python –æ–±—ä–µ–∫—Ç, –∫–æ—Ç–æ—Ä—ã–π, –∫–∞–∫ –º—ã –æ–∂–∏–¥–∞–µ–º, —Å–æ–¥–µ—Ä–∂–∏—Ç —ç–∫–∑–µ–º–ø–ª—è—Ä (–∏–ª–∏ –≤ –Ω–∞—à–µ–º —Å–ª—É—á–∞–µ –ø–æ–¥–∫–ª–∞—Å—Å) –Ω–∞—Ç–∏–≤–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã `pyclass`.  

  


```
#[pyfunction]
fn find_close_polygons(
    py: Python<'_>,
    polygons: Vec<Py<Polygon>>,             // –°—Å—ã–ª–∫–∏ –Ω–∞ –æ–±—ä–µ–∫—Ç—ã, –∫–æ—Ç–æ—Ä—ã–º–∏ –≤–ª–∞–¥–µ–µ—Ç Python.
    point: PyReadonlyArray1<f64>,
    max_dist: f64,
) -> PyResult<Vec<Py<Polygon>>> {           // –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–µ –∂–µ —Å—Å—ã–ª–∫–∏ –Ω–∞ "Py" –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π.
    let mut close_polygons = vec![];
    let point = point.as_array();
    for poly in polygons {
        let center = poly.borrow(py).center // –î–æ–ª–∂–µ–Ω –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å GIL ("py"), —á—Ç–æ–±—ã –ø–æ–∑–∞–∏–º—Å—Ç–≤–æ–≤–∞—Ç—å –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π "Polygon".
            .to_owned();

        if (center - point).norm() < max_dist {
            close_polygons.push(poly)
        }
    }

    Ok(close_polygons)
}
```
  

–ü–æ—Å–º–æ—Ç—Ä–∏–º, —á–µ–≥–æ –º—ã –¥–æ–±–∏–ª–∏—Å—å –ø—Ä–∏ –ø–æ–º–æ—â–∏ —ç—Ç–æ–≥–æ –∫–æ–¥–∞:  

  


```
$ python measure.py
Took an avg of 6.29ms per iteration
```
  

–ú—ã –ø–æ—á—Ç–∏ —É —Ü–µ–ª–∏! –û—Å—Ç–∞–ª–æ—Å—å —É–¥–≤–æ–∏—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å!  

  

‚ñç v3 ‚Äî –∏–∑–±–µ–≥–∞–µ–º —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–π
-----------------------------

  

–î–∞–≤–∞–π—Ç–µ –µ—â—ë —Ä–∞–∑ –∑–∞–ø—É—Å—Ç–∏–º –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤—â–∏–∫.  

  

![](https://habrastorage.org/r/w1560/webt/cy/up/yk/cyupykcpwvnv-wsuytw1se3-fw8.png)*–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –≤–µ—Ä—Å–∏—è –Ω–∞—Ö–æ–¥–∏—Ç—Å—è [–∑–¥–µ—Å—å](https://ohadravid.github.io/posts/2023-03-rusty-python/#v3---avoid-allocations)*  

  

1. –ú—ã –Ω–∞—á–∏–Ω–∞–µ–º –≤–∏–¥–µ—Ç—å `select_best_polygon`, –∫–æ—Ç–æ—Ä–∞—è —Ç–µ–ø–µ—Ä—å –≤—ã–∑—ã–≤–∞–µ—Ç –∫–∞–∫–æ–π-—Ç–æ –∫–æ–¥ –Ω–∞ Rust (–∫–æ–≥–¥–∞ –ø–æ–ª—É—á–∞–µ—Ç –≤–µ–∫—Ç–æ—Ä—ã `x` –∏ `y`)
	* –ú–æ–∂–Ω–æ —ç—Ç–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å, –Ω–æ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª —ç—Ç–æ–≥–æ —É–ª—É—á—à–µ–Ω–∏—è –æ—á–µ–Ω—å –º–∞–ª (–≤–æ–∑–º–æ–∂–Ω–æ, 10%)
2. –ú—ã –≤–∏–¥–∏–º, —á—Ç–æ —Ç—Ä–∞—Ç–∏–º –ø—Ä–∏–º–µ—Ä–Ω–æ 20% –≤—Ä–µ–º–µ–Ω–∏ –≤ `extract_argument` (–≤ `lib_v2.rs:48`), —Ç–æ –µ—Å—Ç—å –ª–∏—à–Ω—è—è —Ç—Ä–∞—Ç–∞ —Ä–µ—Å—É—Ä—Å–æ–≤ –ø–æ-–ø—Ä–µ–∂–Ω–µ–º—É –¥–æ–≤–æ–ª—å–Ω–æ –≤–µ–ª–∏–∫–∞!
	* –ù–æ –±–û–ª—å—à–∞—è —á–∞—Å—Ç—å –≤—Ä–µ–º–µ–Ω–∏ —Ç—Ä–∞—Ç–∏—Ç—Å—è –Ω–∞ `PyIterator::next` –∏ `PyTypeInfo::is_type_of`, —á—Ç–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å –Ω–µ —Ç–∞–∫ –ø—Ä–æ—Å—Ç–æ.
3. –ú—ã –≤–∏–¥–∏–º, —á—Ç–æ –¥–æ–≤–æ–ª—å–Ω–æ –º–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ —Ç—Ä–∞—Ç–∏—Ç—Å—è –Ω–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ!
	* `lib_v2.rs:58` ‚Äî —ç—Ç–æ –Ω–∞—à `if`, –∏ –º—ã –≤–∏–¥–∏–º `drop_in_place` –∏ `to_owned`.
	* –í—Å–µ–≥–æ —ç—Ç–æ –æ–∫–æ–ª–æ 35% –æ—Ç —Å—É–º–º–∞—Ä–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏, —á—Ç–æ –≥–æ—Ä–∞–∑–¥–æ –±–æ–ª—å—à–µ, —á–µ–º –º—ã –æ–∂–∏–¥–∞–ª–∏: –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö —ç—Ç–æ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –±—ã—Å—Ç—Ä–∞—è —á–∞—Å—Ç—å –∫–æ–¥–∞.

  

–î–∞–≤–∞–π—Ç–µ —Ä–∞–∑–±–µ—Ä—ë–º—Å—è —Å –ø–æ—Å–ª–µ–¥–Ω–∏–º –ø—É–Ω–∫—Ç–æ–º.  

  

–í–æ—Ç —Ñ—Ä–∞–≥–º–µ–Ω—Ç –∫–æ–¥–∞, –≤—ã–∑—ã–≤–∞—é—â–∏–π –ø—Ä–æ–±–ª–µ–º—ã:  

  


```
let center = poly.borrow(py).center
    .to_owned();

if (center - point).norm() < max_dist { ... } 
```
  

–ú—ã —Ö–æ—Ç–∏–º –∏–∑–±–µ–∂–∞—Ç—å –≤–æ—Ç —ç—Ç–æ–≥–æ `to_owned`. –ù–æ –Ω–∞–º –Ω—É–∂–µ–Ω owned-–æ–±—ä–µ–∫—Ç –¥–ª—è `norm`, –ø–æ—ç—Ç–æ–º—É –ø—Ä–∏–¥—ë—Ç—Å—è —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –µ–≥–æ –≤—Ä—É—á–Ω—É—é.  

  

(–ü—Ä–∏—á–∏–Ω–∞ —Ç–æ–≥–æ, —á—Ç–æ –º—ã –º–æ–∂–µ–º —É–ª—É—á—à–∏—Ç—å `ndarray`, –∑–∞–∫–ª—é—á–∞–µ—Ç—Å—è –≤ —Ç–æ–º, —á—Ç–æ –º—ã –∑–Ω–∞–µ–º, —á—Ç–æ –Ω–∞—à –º–∞—Å—Å–∏–≤ –Ω–∞ —Å–∞–º–æ–º –¥–µ–ª–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —Å–æ–±–æ–π –¥–≤–∞ –∑–Ω–∞—á–µ–Ω–∏—è `f32`).  

  

–≠—Ç–æ –±—É–¥–µ—Ç –≤—ã–≥–ª—è–¥–µ—Ç—å —Ç–∞–∫:  

  


```
use ndarray_linalg::Scalar;

let center = &poly.as_ref(py).borrow().center;

if ((center[0] - point[0]).square() + (center[1] - point[1]).square()).sqrt() < max_dist {
    close_polygons.push(poly)
}
```
  

–ù–æ, —É–≤—ã, borrow checker –Ω–∞–º–∏ –Ω–µ–¥–æ–≤–æ–ª–µ–Ω:  

  


```
error[E0505]: cannot move out of `poly` because it is borrowed
  --> src/lib.rs:58:33
   |
55 |         let center = &poly.as_ref(py).borrow().center;
   |                       ------------------------
   |                       |
   |                       borrow of `poly` occurs here
   |                       a temporary with access to the borrow is created here ...
...
58 |             close_polygons.push(poly);
   |                                 ^^^^ move out of `poly` occurs here
59 |         }
60 |     }
   |     - ... and the borrow might be used here, when that temporary is dropped and runs the `Drop` code for type `PyRef`
```
  

–ö–∞–∫ –æ–±—ã—á–Ω–æ, borrow checker –ø—Ä–∞–≤: –º—ã —Å–æ–≤–µ—Ä—à–∞–µ–º –ø—Ä–µ—Å—Ç—É–ø–ª–µ–Ω–∏—è —Å –ø–∞–º—è—Ç—å—é.  

  

–ü—Ä–æ—â–µ –≤—Å–µ–≥–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å —ç—Ç–æ –ø—Ä–∏ –ø–æ–º–æ—â–∏ *Just Clone*, –ø–æ—Å–ª–µ —á–µ–≥–æ `close_polygons.push(poly.clone())` —Å–∫–æ–º–ø–∏–ª–∏—Ä—É–µ—Ç—Å—è.  

  

–ù–∞ —Å–∞–º–æ–º –¥–µ–ª–µ, —ç—Ç–æ –æ—á–µ–Ω—å –º–∞–ª–æ–∑–∞—Ç—Ä–∞—Ç–Ω—ã–π –∫–ª–æ–Ω, –ø–æ—Ç–æ–º—É —á—Ç–æ –º—ã –≤—Å–µ–≥–æ –ª–∏—à—å –≤—ã–ø–æ–ª–Ω—è–µ–º `incr` —Å—á—ë—Ç—á–∏–∫–∞ —Å—Å—ã–ª–æ–∫ –æ–±—ä–µ–∫—Ç–∞ Python.  

  

–û–¥–Ω–∞–∫–æ –≤ —ç—Ç–æ–º —Å–ª—É—á–∞–µ –º—ã –º–æ–∂–µ–º —Å–æ–∫—Ä–∞—Ç–∏—Ç—å borrow, —Å–¥–µ–ª–∞–≤ –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π —Ç—Ä—é–∫ Rust:  

  


```
let norm = {
    let center = &poly.as_ref(py).borrow().center;

    ((center[0] - point[0]).square() + (center[1] - point[1]).square()).sqrt()
};

if norm < max_dist {
    close_polygons.push(poly)
}
```
  

–¢–∞–∫ –∫–∞–∫ `poly` –∑–∞–∏–º—Å—Ç–≤—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π –æ–±–ª–∞—Å—Ç–∏ –≤–∏–¥–∏–º–æ—Å—Ç–∏, –ø–æ—Å–ª–µ —Ç–æ–≥–æ –∫–∞–∫ –º—ã –¥–æ—Å—Ç–∏–≥–Ω–µ–º `close_polygons.push`, –∫–æ–º–ø–∏–ª—è—Ç–æ—Ä —Å–º–æ–∂–µ—Ç —É–∑–Ω–∞—Ç—å, —á—Ç–æ –º—ã –±–æ–ª—å—à–µ –Ω–µ —Ö—Ä–∞–Ω–∏–º —ç—Ç—É —Å—Å—ã–ª–∫—É –∏ —Å–ø–æ–∫–æ–π–Ω–æ —Å–∫–æ–º–ø–∏–ª–∏—Ä—É–µ—Ç –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é.  

  

–ù–∞–∫–æ–Ω–µ—Ü, –º—ã –¥–æ–±–∏–ª–∏—Å—å —Å–ª–µ–¥—É—é—â–µ–≥–æ:  

  


```
$ python measure.py
Took an avg of 2.90ms per iteration
```
  

–°—Ç–æ–∫—Ä–∞—Ç–Ω–æ–µ —É–ª—É—á—à–µ–Ω–∏–µ –ø–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—é —Å –ø–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω—ã–º –∫–æ–¥–æ–º.  

  

‚ñç –ü–æ–¥–≤–µ–¥–µ–Ω–∏–µ –∏—Ç–æ–≥–æ–≤
-------------------

  

–ú—ã –Ω–∞—á–∏–Ω–∞–ª–∏ —Å —Ç–∞–∫–æ–≥–æ –∫–æ–¥–∞ –Ω–∞ Python:  

  


```
@dataclass
class Polygon:
    x: np.array
    y: np.array
    _area: float = None

    @cached_property
    def center(self) -> np.array:
        centroid = np.array([self.x, self.y]).mean(axis=1)
        return centroid

    def area(self) -> float:
        ...

def find_close_polygons(
    polygon_subset: List[Polygon], point: np.array, max_dist: float
) -> List[Polygon]:
    close_polygons = []
    for poly in polygon_subset:
        if np.linalg.norm(poly.center - point) < max_dist:
            close_polygons.append(poly)

    return close_polygons

# –û—Å—Ç–∞–ª—å–Ω–∞—è —á–∞—Å—Ç—å —Ñ–∞–π–ª–∞ (main, select_best_polygon).
```
  

–ú—ã –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–ª–∏ –µ–≥–æ –ø—Ä–∏ –ø–æ–º–æ—â–∏ `py-spy`, –∏ –¥–∞–∂–µ —Å–∞–º–∞—è –Ω–∞–∏–≤–Ω–∞—è –ø–æ—Å—Ç—Ä–æ—á–Ω–∞—è —Ç—Ä–∞–Ω—Å–ª—è—Ü–∏—è `find_close_polygons` –æ–±–µ—Å–ø–µ—á–∏–ª–∞ —É–ª—É—á—à–µ–Ω–∏–µ –≤ –¥–µ—Å—è—Ç—å —Å –ª–∏—à–Ω–∏–º —Ä–∞–∑.  

  

–ú—ã –≤—ã–ø–æ–ª–Ω–∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∏—Ç–µ—Ä–∞—Ü–∏–π ¬´–ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ-–Ω–∞–ø–∏—Å–∞–Ω–∏–µ –∫–æ–¥–∞-–∏–∑–º–µ—Ä–µ–Ω–∏—è¬ª, –ø–æ–∫–∞ –Ω–µ –ø–æ–ª—É—á–∏–ª–∏ —Å—Ç–æ–∫—Ä–∞—Ç–Ω–æ–µ —É–ª—É—á—à–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è, —Å–æ—Ö—Ä–∞–Ω–∏–≤ –ø—Ä–∏ —ç—Ç–æ–º —Ç–æ—Ç –∂–µ API, —á—Ç–æ –∏ —É –∏—Å—Ö–æ–¥–Ω–æ–π –±–∏–±–ª–∏–æ—Ç–µ–∫–∏.  

  



| –í–µ—Ä—Å–∏—è | –°—Ä. –≤—Ä–µ–º—è –Ω–∞ –∏—Ç–µ—Ä–∞—Ü–∏—é (–º—Å) | –ú–Ω–æ–∂–∏—Ç–µ–ª—å |
| --- | --- | --- |
| –ë–∞–∑–æ–≤–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è (–Ω–∞ Python) | 293,41 | 1x |
| –ù–∞–∏–≤–Ω–∞—è –ø–æ—Å—Ç—Ä–æ—á–Ω–∞—è —Ç—Ä–∞–Ω—Å–ª—è—Ü–∏—è –Ω–∞ Rust `find_close_polygons` | 23,44 | 12,50x |
| –†–µ–∞–ª–∏–∑–∞—Ü–∏—è `Polygon` –Ω–∞ Rust | 6,29 | 46,53x |
| –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–π –Ω–∞ Rust | 2,90 | 101,16x |

–û–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω—ã–π –∫–æ–¥ –Ω–∞ Python –≤—ã–≥–ª—è–¥–∏—Ç —Ç–∞–∫:  

  


```
import poly_match_rs
from poly_match_rs import find_close_polygons

class Polygon(poly_match_rs.Polygon):
    _area: float = None

    def area(self) -> float:
        ...

# –û—Å—Ç–∞–≤—à–∞—è—Å—è —á–∞—Å—Ç—å —Ñ–∞–π–ª–∞ –Ω–µ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å (main, select_best_polygon).
```
  

–û–Ω –≤—ã–∑—ã–≤–∞–µ—Ç —Å–ª–µ–¥—É—é—â–∏–π –∫–æ–¥ –Ω–∞ Rust:  

  


```
use pyo3::prelude::*;

use ndarray::Array1;
use ndarray_linalg::Scalar;
use numpy::{PyArray1, PyReadonlyArray1, ToPyArray};

#[pyclass(subclass)]
struct Polygon {
    x: Array1<f64>,
    y: Array1<f64>,
    center: Array1<f64>,
}

#[pymethods]
impl Polygon {
    #[new]
    fn new(x: PyReadonlyArray1<f64>, y: PyReadonlyArray1<f64>) -> Polygon {
        let x = x.as_array();
        let y = y.as_array();
        let center = Array1::from_vec(vec![x.mean().unwrap(), y.mean().unwrap()]);

        Polygon {
            x: x.to_owned(),
            y: y.to_owned(),
            center,
        }
    }

    #[getter]
    fn x(&self, py: Python<'_>) -> PyResult<Py<PyArray1<f64>>> {
        Ok(self.x.to_pyarray(py).to_owned())
    }

    // –¢–æ –∂–µ –¥–ª—è "y" –∏ "center".
}

#[pyfunction]
fn find_close_polygons(
    py: Python<'_>,
    polygons: Vec<Py<Polygon>>,
    point: PyReadonlyArray1<f64>,
    max_dist: f64,
) -> PyResult<Vec<Py<Polygon>>> {
    let mut close_polygons = vec![];
    let point = point.as_array();
    for poly in polygons {
        let norm = {
            let center = &poly.as_ref(py).borrow().center;

            ((center[0] - point[0]).square() + (center[1] - point[1]).square()).sqrt()
        };

        if norm < max_dist {
            close_polygons.push(poly)
        }
    }

    Ok(close_polygons)
}

#[pymodule]
fn poly_match_rs(_py: Python, m: &PyModule) -> PyResult<()> {
    m.add_class::<Polygon>()?;
    m.add_function(wrap_pyfunction!(find_close_polygons, m)?)?;
    Ok(())
}
```
  

‚ñç –í—ã–≤–æ–¥—ã
--------

  

* Rust (–ø—Ä–∏ –ø–æ–º–æ—â–∏ pyo3) —Ä–∞—Å–∫—Ä—ã–≤–∞–µ—Ç –∏—Å—Ç–∏–Ω–Ω—É—é –Ω–∞—Ç–∏–≤–Ω—É—é –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø–æ–≤—Å–µ–¥–Ω–µ–≤–Ω–æ–≥–æ –∫–æ–¥–∞ –Ω–∞ Python —Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º–∏ –∫–æ–º–ø—Ä–æ–º–∏—Å—Å–∞–º–∏.
* Python ‚Äî –ø—Ä–µ–≤–æ—Å—Ö–æ–¥–Ω—ã–π API –¥–ª—è –∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª–µ–π, –∞ —Å–æ–∑–¥–∞–Ω–∏–µ –±—ã—Å—Ç—Ä—ã—Ö —Å—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω—ã—Ö –±–ª–æ–∫–æ–≤ –Ω–∞ Rust ‚Äî —ç—Ç–æ —á—Ä–µ–∑–≤—ã—á–∞–π–Ω–æ –º–æ—â–Ω–æ–µ —Å–æ—á–µ—Ç–∞–Ω–∏–µ.
* –ü—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∫—Ä–∞–π–Ω–µ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ, –æ–Ω–æ –º–æ—Ç–∏–≤–∏—Ä—É–µ—Ç –ø–æ-–Ω–∞—Å—Ç–æ—è—â–µ–º—É —Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è —Å–æ –≤—Å–µ–º, —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤ –≤–∞—à–µ–º –∫–æ–¥–µ.

  

–ò –ø–æ—Å–ª–µ–¥–Ω–µ–µ: –∫–æ–º–ø—å—é—Ç–µ—Ä—ã *–±–µ–∑—É–º–Ω–æ –±—ã—Å—Ç—Ä—ã*. –ö–æ–≥–¥–∞ –≤–∞–º –≤ —Å–ª–µ–¥—É—é—â–∏–π —Ä–∞–∑ –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç —á—Ç–æ-—Ç–æ —Å–¥–µ–ª–∞—Ç—å, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –∑–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤—â–∏–∫, –≤–æ–∑–º–æ–∂–Ω–æ, –≤—ã –Ω–∞—É—á–∏—Ç–µ—Å—å —á–µ–º—É-—Ç–æ –Ω–æ–≤–æ–º—É.  

  


> **[–ü–æ–ª-–ª–∏–º–æ–Ω–∞ –ø–æ–¥–∞—Ä–∫–æ–≤ –æ—Ç RUVDS. –û—Ç–≤–µ—á–∞–π –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –∏ –ø–æ–ª—É—á–∞–π –ø—Ä–∏–∑—ã üçã](https://habr.com/ru/specials/731732/)**

[![](https://habrastorage.org/r/w1560/webt/_p/_h/lv/_p_hlvd2tv0cv9tny8tdytzfhje.png)](http://ruvds.com/ru-rub?utm_source=habr&utm_medium=article&utm_campaign=perevod&utm_content=uskoryaem_python_v_sto_raz_pri_pomoshhi_menee_chem_sta_strok_na_rust)