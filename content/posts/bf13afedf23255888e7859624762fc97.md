---
title: –ö–∞–∫ –≤ 180 000 —Ä–∞–∑ —É—Å–∫–æ—Ä–∏—Ç—å –∞–Ω–∞–ª–∏–∑ –¥–∞–Ω–Ω—ã—Ö —Å –ø–æ–º–æ—â—å—é Rust / –•–∞–±—Ä
date: 2023-10-28
src_link: https://www.notion.so/180-000-Rust-2f1be24683e14384bc32d1a428d43817
src_date: '2023-10-28 13:51:00'
gold_link: https://habr.com/ru/companies/ruvds/articles/769808/
gold_link_hash: bf13afedf23255888e7859624762fc97
tags:
- '#host_habr_com'
---

[![](https://habrastorage.org/r/w780q1/webt/dm/mb/vj/dmmbvjo4prkdwo8rmilimlu8or0.jpeg)](https://habr.com/ru/companies/ruvds/articles/769808/)  

–í —ç—Ç–æ–π —Å—Ç–∞—Ç—å–µ —è –æ–ø–∏—à—É –æ–¥–Ω–æ –∏–∑ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Å–≤–æ–∏—Ö –¥–µ—Ä–∑–Ω–æ–≤–µ–Ω–∏–π –≤ —Å—Ñ–µ—Ä–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ —Å –ø–æ–º–æ—â—å—é Rust. –ù–∞–¥–µ—é—Å—å, —á—Ç–æ –≤ –Ω–µ–π –≤—ã –æ—Ç–∫—Ä–æ–µ—Ç–µ –¥–ª—è —Å–µ–±—è –∫–∞–∫–∏–µ-—Ç–æ –Ω–æ–≤—ã–µ –ø—Ä–∏—ë–º—ã –¥–ª—è –Ω–∞–ø–∏—Å–∞–Ω–∏—è –±—ã—Å—Ç—Ä–æ–≥–æ –∫–æ–¥–∞ –Ω–∞ Rust.   

  

–ö–æ–Ω—Ç–µ–∫—Å—Ç —Å–ª–µ–¥—É—é—â–∏–π: –ø—Ä–µ–¥—Å—Ç–∞–≤—å—Ç–µ, —á—Ç–æ —É –≤–∞—Å –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ –æ–Ω–ª–∞–π–Ω-—ç–∫–∑–∞–º–µ–Ω–∞, –≤ –∫–æ—Ç–æ—Ä–æ–º –º–Ω–æ–∂–µ—Å—Ç–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –æ—Ç–≤–µ—á–∞–ª–∏ –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã. –í —Å—ã—Ä–æ–º –≤–∏–¥–µ —ç—Ç–∏ –¥–∞–Ω–Ω—ã–µ –≤—ã–≥–ª—è–¥—è—Ç —Ç–∞–∫:  

  


```
[
{
"user": "5ea2c2e3-4dc8-4a5a-93ec-18d3d9197374",
"question": "7d42b17d-77ff-4e0a-9a4d-354ddd7bbc57",
"score": 1
},
{
"user": "b7746016-fdbf-4f8a-9f84-05fde7b9c07a",
"question": "7d42b17d-77ff-4e0a-9a4d-354ddd7bbc57",
"score": 0
}, 
/* ... –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ ... */
]
```
  

–ó–∞–º–µ—Ç—å—Ç–µ, —á—Ç–æ –Ω–µ –≤—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ—Ç–≤–µ—Ç–∏–ª–∏ –Ω–∞ –∫–∞–∂–¥—ã–π –≤–æ–ø—Ä–æ—Å, –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã, –≤ —Å–≤—è–∑–∏ —Å —ç—Ç–∏–º, –±—ã–ª–∏ –æ—Ç–º–µ—á–µ–Ω—ã –∫–∞–∫ 0 –ª–∏–±–æ 1.  

  

–ó–∞–¥–∞—á–∞: –¥–∞–Ω–æ –Ω–µ–∫–æ–µ `k`. –ö–∞–∫–æ–µ –º–Ω–æ–∂–µ—Å—Ç–≤–æ –∏–∑ `k` –≤–æ–ø—Ä–æ—Å–æ–≤ –±—É–¥–µ—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –∫–æ—Ä—Ä–µ–ª–∏—Ä–æ–≤–∞—Ç—å —Å –æ–±—â–∏–º –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–º —ç–∫–∑–∞–º–µ–Ω–∞? –ù–∞–∑–æ–≤—ë–º —ç—Ç–æ –∑–∞–¥–∞—á–µ–π k-CorrSet. –ü—Ä–æ—Å—Ç–æ–π –∞–ª–≥–æ—Ä–∏—Ç–º –ø–µ—Ä–µ–±–æ—Ä–∞ –¥–ª—è —Ä–µ—à–µ–Ω–∏—è —ç—Ç–æ–π –∑–∞–¥–∞—á–∏ –≤ –≤–∏–¥–µ –ø—Å–µ–≤–¥–æ–∫–æ–¥–∞ –±—É–¥–µ—Ç —Ç–∞–∫–∏–º:  

  


```
func k_corrset($data, $k):
$all_qs = all questions in $data
for all $k-sized subsets $qs within $all_qs:
  $us = all users that answered every question in $qs
  $qs_totals = the total score on $qs of each user in $us
  $grand_totals = the grand score on $all_qs of each user in $us
  $r = correlation($qs_totals, $grand_totals)
 return $qs with maximum $r 
```
  

–î–∞–ª–µ–µ –º—ã —Ä–µ–∞–ª–∏–∑—É–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–∞—Ä–∏–∞—Ü–∏–π —ç—Ç–æ–≥–æ –∞–ª–≥–æ—Ä–∏—Ç–º–∞, —á—Ç–æ–±—ã –≤—ã—è—Å–Ω–∏—Ç—å, –Ω–∞—Å–∫–æ–ª—å–∫–æ –µ–≥–æ –º–æ–∂–Ω–æ —É—Å–∫–æ—Ä–∏—Ç—å.  

  

‚ñç –û—Å–Ω–æ–≤–∞ –Ω–∞ Python
------------------

  

–ê–Ω–∞–ª–∏–∑ –¥–∞–Ω–Ω—ã—Ö —è –æ–±—ã—á–Ω–æ –Ω–∞—á–∏–Ω–∞—é —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è Python –∏ –∑–∞—Ç–µ–º —É–∂–µ –ø–µ—Ä–µ—Ö–æ–∂—É –Ω–∞ Rust, –∫–æ–≥–¥–∞ –≤–æ–∑–Ω–∏–∫–∞–µ—Ç –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—å –ø–æ–≤—ã—Å–∏—Ç—å —Å–∫–æ—Ä–æ—Å—Ç—å –∏–ª–∏ —Å–Ω–∏–∑–∏—Ç—å –∑–∞—Ç—Ä–∞—Ç—ã –ø–∞–º—è—Ç–∏. –¢–∞–∫ —á—Ç–æ –≤ –∫–∞—á–µ—Å—Ç–≤–µ –æ—Å–Ω–æ–≤—ã –ø—Ä–µ–¥–ª–∞–≥–∞—é —Ä–∞–∑–æ–±—Ä–∞—Ç—å –ø—Ä–æ—Å—Ç—É—é –ø—Ä–æ–≥—Ä–∞–º–º—É –¥–ª—è —Ä–µ—à–µ–Ω–∏—è k-CorrSet, –Ω–∞–ø–∏—Å–∞–Ω–Ω—É—é —Å –ø–æ–º–æ—â—å—é [Pandas](https://pandas.pydata.org/):  

  


```
from itertools import combinations
import pandas as pd
from pandas import IndexSlice as islice

def k_corrset(data, K):
   all_qs = data.question.unique()
   q_to_score = data.set_index(['question', 'user'])
   all_grand_totals = data.groupby('user').score.sum().rename('grand_total')

   corrs = []
   for qs in combinations(all_qs, K):
        qs_data = q_to_score.loc[islice[qs,:],:].swaplevel()
        answered_all = qs_data.groupby(level=[0]).size() == K
        answered_all = answered_all[answered_all].index
        qs_totals = qs_data.loc[islice[answered_all,:]] \
              .groupby(level=[0]).sum().rename(columns={'score': 'qs'})
        r = qs_totals.join(all_grand_totals).corr().qs.grand_total
        corrs.append({'qs': qs, 'r': r})
  corrs = pd.DataFrame(corrs)

  return corrs.sort_values('r', ascending=False).iloc[0].qs

data = pd.read_json('scores.json')
print(k_corrset(data, K=5))
```
  

–í –Ω–µ–π –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –º–∞–≥–∏—è [MultiIndex](https://pandas.pydata.org/docs/user_guide/advanced.html), –Ω–æ –¥–µ—Ç–∞–ª–∏ –æ–ø—É—Å—Ç–∏–º. –°—Ä–∞–∑—É –Ω–∞—á–Ω—ë–º —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ. –î–ª—è —ç—Ç–æ–≥–æ –Ω–∞–º –Ω—É–∂–Ω—ã –¥–∞–Ω–Ω—ã–µ. –ß—Ç–æ–±—ã —Å–¥–µ–ª–∞—Ç—å –±–µ–Ω—á–º–∞—Ä–∫ —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–º, —è —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–ª —Å–∏–Ω—Ç–µ—Ç–∏—á–µ—Å–∫–∏–π –¥–∞—Ç–∞—Å–µ—Ç, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–∏–º–µ—Ä–Ω–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ä–µ–∞–ª—å–Ω–æ–º—É. –í–æ—Ç –µ–≥–æ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏:  

  

* 60,000 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π;
* 200 –≤–æ–ø—Ä–æ—Å–æ–≤;
* 20% –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω–æ—Å—Ç–∏ (—Ç–æ –µ—Å—Ç—å –Ω–∞ –≤—Å–µ –≤–æ–ø—Ä–æ—Å—ã –æ—Ç–≤–µ—Ç–∏–ª–æ 12,000 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π);
* –∫–∞–∂–¥—ã–π –±–∞–ª –º–æ–∂–µ—Ç —Å —Ä–∞–≤–Ω–æ–π –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å—é –±—ã—Ç—å 1 –∏–ª–∏ 0.

  

–ù–∞—à–∞ —Ü–µ–ª—å ‚Äì –≤—ã—á–∏—Å–ª–∏—Ç—å –¥–ª—è —ç—Ç–æ–≥–æ –¥–∞—Ç–∞—Å–µ—Ç–∞ k-CorrSet –ø—Ä–∏ `k=5` –Ω–∞ –º–æ—ë–º M1 MacBook Pro 2021 –≥–æ–¥–∞ –∑–∞ –∞–¥–µ–∫–≤–∞—Ç–Ω—ã–π –ø—Ä–æ–º–µ–∂—É—Ç–æ–∫ –≤—Ä–µ–º–µ–Ω–∏. –ó–∞–º–µ—Ç—å—Ç–µ, —á—Ç–æ –≤—Å–µ–≥–æ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç 2,5 –º–∏–ª–ª–∏–∞—Ä–¥–∞ –∫–æ–º–±–∏–Ω–∞—Ü–∏–π –≤–æ–ø—Ä–æ—Å–æ–≤, –ø–æ—ç—Ç–æ–º—É –Ω—É–∂–Ω–æ, —á—Ç–æ–±—ã –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π —Ü–∏–∫–ª –∞–ª–≥–æ—Ä–∏—Ç–º–∞ –±—Ä—É—Ç—Ñ–æ—Ä—Å–∞ –±—ã–ª –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±—ã—Å—Ç—Ä.   

  

–ò—Å–ø–æ–ª—å–∑—É—è —Ñ—É–Ω–∫—Ü–∏—é Python `[time.time()](https://docs.python.org/3/library/time.html#time.time)`, —è –≤—ã—á–∏—Å–ª–∏–ª —Å–∫–æ—Ä–æ—Å—Ç—å —ç—Ç–æ–≥–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ —Ü–∏–∫–ª–∞ –ø—Ä–∏ 1,000 –∏—Ç–µ—Ä–∞—Ü–∏–π –≤ CPython 3.9.17. –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–∞–≤–∏–ª–æ 36 –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥. –ù–µ–ø–ª–æ—Ö–æ, –Ω–æ –ø—Ä–∏ —Ç–∞–∫–æ–π —Å–∫–æ—Ä–æ—Å—Ç–∏ –Ω–∞ –æ–±—â–µ–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ —É–π–¥—ë—Ç 2,9 –≥–æ–¥–∞. –ù—É–∂–Ω–æ –µ–≥–æ —É—Å–∫–æ—Ä–∏—Ç—å!  

  


> *–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ*: –µ—Å—Ç—å —Ä–∞–∑–Ω—ã–µ —Å–ø–æ—Å–æ–±—ã —É—Å–∫–æ—Ä–µ–Ω–∏—è –∫–æ–¥–∞ Python, –Ω–æ –º–æ—è —Ü–µ–ª—å —Å—Ä–∞–≤–Ω–∏—Ç—å –Ω–µ –≤—ã—Å–æ–∫–æ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–¥ Python —Å –≤—ã—Å–æ–∫–æ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –∫–æ–¥–æ–º Rust, –∞ —Å–∫–æ—Ä–æ—Å—Ç—å –≤—ã—á–∏—Å–ª–µ–Ω–∏—è ¬´—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–≥–æ –±–ª–æ–∫–Ω–æ—Ç–∞ Jupyter¬ª –≤ Python —Å–æ —Å–∫–æ—Ä–æ—Å—Ç—å—é –µ–≥–æ –≤—ã—Å–æ–∫–æ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–æ–π –Ω–∞ Rust.

  

‚ñç –ü–µ—Ä–µ–≤–æ–¥ –≤ Rust
----------------

  

–ù–∞—á–∞—Ç—å –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—é –º–æ–∂–Ω–æ —Å –ø–æ–≤—Ç–æ—Ä–Ω–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–æ–¥–∞ Python –≤ –∫–∞—á–µ—Å—Ç–≤–µ –ø—Ä–∏–º–µ—Ä–Ω–æ —Ç–∞–∫–æ–π –∂–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã Rust. –í —ç—Ç–æ–º —Å–ª—É—á–∞–µ –º—ã –±—É–¥–µ–º –æ–∂–∏–¥–∞—Ç—å –Ω–µ–∫–æ—Ç–æ—Ä–æ–≥–æ —É—Å–∫–æ—Ä–µ–Ω–∏—è –∑–∞ —Å—á—ë—Ç –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π –∫–æ–º–ø–∏–ª—è—Ç–æ—Ä–∞ Rust. –í —Ü–µ–ª—è—Ö —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏ –≤–µ—Å—å –∫–æ–¥ –Ω–∏–∂–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —É–ø—Ä–æ—â–µ–Ω–∏–µ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–≥–æ –±–µ–Ω—á–º–∞—Ä–∫–∞. –ö –ø—Ä–∏–º–µ—Ä—É, —è –±—É–¥—É –æ–ø—É—Å–∫–∞—Ç—å `#[derive]` –≤ —Ç–∏–ø–∞—Ö –∏ –æ–±—ä–µ–¥–∏–Ω—è—Ç—å —Ä–∞–∑—Ä–æ–∑–Ω–µ–Ω–Ω—ã–µ –±–ª–æ–∫–∏ –∫–æ–¥–∞ –≤ –ø—Ä—è–º–æ–ª–∏–Ω–µ–π–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏. –í–µ—Å—å –±–µ–Ω—á–º–∞—Ä–∫ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ [—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ –Ω–∞ GitHub](https://github.com/willcrichton/corrset-benchmark).  

  

–°–ø–µ—Ä–≤–∞ –ø–µ—Ä–µ–≤–µ–¥—ë–º —Ç–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö:  

  


```
pub struct User(pub String);

pub struct Question(pub String);

pub struct Row {
    pub user: User,
    pub question: Question,
    pub score: u32,
}
```
  

–ú—ã –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ–º `User` –∏ `Question` –≤ –Ω–æ–≤—ã–µ —Ç–∏–ø—ã –¥–ª—è —è—Å–Ω–æ—Å—Ç–∏, –∏ —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –¥–ª—è –Ω–∏—Ö —Ç—Ä–µ–π—Ç—ã. –ó–∞—Ç–µ–º —Ä–µ–∞–ª–∏–∑—É–µ–º –±–∞–∑–æ–≤—ã–π –∞–ª–≥–æ—Ä–∏—Ç–º k-CorrSet —Ç–∞–∫:  

  


```
fn k_corrset(data: &[Row], k: usize) -> Vec<&Question> {
  // utils::group_by(impl Iterator<Item = (K1, K2, V)>) 
  //   -> HashMap<K1, HashMap<K2, V>>;
  let q_to_score: HashMap<&Question, HashMap<&User, u32>> = 
    utils::group_by(data.iter().map(|r| (&r.question, &r.user, r.score)));
  let u_to_score: HashMap<&User, HashMap<&Question, u32>> = 
    utils::group_by(data.iter().map(|r| (&r.user, &r.question, r.score)));
  let all_grand_totals: HashMap<&User, u32> = 
    u_to_score.iter().map(|(user, scores)| {
      let total = scores.values().sum::<u32>();
      (*user, total)
    })
    .collect();

  let all_qs = q_to_score.keys().copied();
  all_qs.combinations(k)
    .filter_map(|qs: Vec<&Question>| {
      let (qs_totals, grand_totals): (Vec<_>, Vec<_>) = all_grand_totals.iter()
        .filter_map(|(u, grand_total)| {
          let q_total = qs.iter()
            .map(|q| q_to_score[*q].get(u).copied())
            .sum::<Option<u32>>()?;
          Some((q_total as f64, *grand_total as f64))
        })
        .unzip();
      // utils::correlation(&[f64], &[f64]) -> f64;
      let r = utils::correlation(&qs_totals, &grand_totals);
      (!r.is_nan()).then_some((qs, r))
    })
    .max_by_key(|(_, r)| FloatOrd(*r))
    .unwrap().0
}
```
  

–ß—Ç–æ –∑–¥–µ—Å—å –≤–∞–∂–Ω–æ –ø–æ–Ω—è—Ç—å:  

  

* –ö–∞–∫ –∏ –≤ —Å–ª—É—á–∞–µ Python, –º—ã –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –ø–ª–æ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ –≤ –∏–µ—Ä–∞—Ä—Ö–∏—á–µ—Å–∫–∏–µ, –∏—Å–ø–æ–ª—å–∑—É—è —Ö—ç—à-—Ç–∞–±–ª–∏—Ü—É –∏ –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é `utils::group_by`. (–ò–º–µ–π—Ç–µ –≤–≤–∏–¥—É, –≤—Å—ë, —á—Ç–æ –º—ã –Ω–∞–∑—ã–≤–∞–µ–º `HashMap`, —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏ –≤—ã—Å—Ç—É–ø–∞–µ—Ç –ø—Å–µ–≤–¥–æ–Ω–∏–º–æ–º –¥–ª—è `[fxhash::FxHashMap](https://docs.rs/fxhash/0.2.1/fxhash/type.FxHashMap.html)`, –∫–æ—Ç–æ—Ä–∞—è —è–≤–ª—è–µ—Ç—Å—è –ø—Ä–æ—Å—Ç–æ `[std::collections::HashMap](https://doc.rust-lang.org/stable/std/collections/struct.HashMap.html)` —Å –±–æ–ª–µ–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–º –∞–ª–≥–æ—Ä–∏—Ç–º–æ–º —Ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è).
* –ó–∞—Ç–µ–º –º—ã –ø–µ—Ä–µ–±–∏—Ä–∞–µ–º –≤—Å–µ –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏ –≤–æ–ø—Ä–æ—Å–æ–≤ –º–µ—Ç–æ–¥–æ–º `[Itertools::combinations](https://docs.rs/itertools/0.11.0/itertools/trait.Itertools.html#method.combinations)`.
* –í–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–º —Ü–∏–∫–ª–µ –º—ã –ø–µ—Ä–µ–±–∏—Ä–∞–µ–º –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ—Å—Ä–µ–¥—Å—Ç–≤–æ–º `all_grand_totals.iter()`.
* –í—ã—Ä–∞–∂–µ–Ω–∏–µ `q_to_score[*q].get(u).copied()` –∏–º–µ–µ—Ç —Ç–∏–ø `Option<u32 >`, –∫–æ—Ç–æ—Ä—ã–π –æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è `Some(n)`, –µ—Å–ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ—Ç–º–µ—á–µ–Ω –±–∞–ª–ª –¥–ª—è `q`, –∏ `None` –≤ –ø—Ä–æ—Ç–∏–≤–Ω–æ–º —Å–ª—É—á–∞–µ.
* –ò—Ç–µ—Ä–∞—Ç–æ—Ä `.sum::<Option<u32>>()` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `Some(total)`, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–≤–µ—Ç–∏–ª –Ω–∞ –≤—Å–µ –≤–æ–ø—Ä–æ—Å—ã –≤ `qs`, –∏ `None` –≤ –ø—Ä–æ—Ç–∏–≤–Ω–æ–º —Å–ª—É—á–∞–µ.
* –ú—ã –≤—ã–∑—ã–≤–∞–µ–º –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–π –º–µ—Ç–æ–¥ `utils::correlation`, –∫–æ—Ç–æ—Ä—ã–π —Ä–µ–∞–ª–∏–∑—É–µ—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ [–∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–∞ –∫–æ—Ä—Ä–µ–ª—è—Ü–∏–∏ –ü–∏—Ä—Å–æ–Ω–∞](https://en.wikipedia.org/wiki/Pearson_correlation_coefficient).
* –° –ø–æ–º–æ—â—å—é `max_by_key` –º—ã –ø–æ–ª—É—á–∞–µ–º –≤–æ–ø—Ä–æ—Å—ã, –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –∫–æ—Ä—Ä–µ–ª–∏—Ä—É—é—â–∏–µ —Å –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–º —ç–∫–∑–∞–º–µ–Ω–∞. –ü–æ–º–∏–º–æ —ç—Ç–æ–≥–æ, –º—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º `[FloatOrd](https://docs.rs/float-ord/0.3.2/float_ord/struct.FloatOrd.html)`, —á—Ç–æ–±—ã –∏–º–µ—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —Å—Ä–∞–≤–Ω–∏–≤–∞—Ç—å —á–∏—Å–ª–∞ —Å –ø–ª–∞–≤–∞—é—â–µ–π –∑–∞–ø—è—Ç–æ–π.

  

–ò –∫–∞–∫–∞—è –ø–æ–ª—É—á–∏–ª–∞—Å—å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å? –î–ª—è –æ—Ü–µ–Ω–∫–∏ –±—ã—Å—Ç—Ä–æ–¥–µ–π—Å—Ç–≤–∏—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ —Ü–∏–∫–ª–∞ (`filter_map`) —è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª [Criterion](https://bheisler.github.io/criterion.rs/book/index.html) —Å —É—Å—Ç–∞–Ω–æ–≤–∫–∞–º–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, –≤–∑—è–≤ —Ç–æ—Ç –∂–µ –¥–∞—Ç–∞—Å–µ—Ç. –ù–æ–≤—ã–π –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π —Ü–∏–∫–ª –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –∑–∞ 4,2 –º—Å, —á—Ç–æ –ø—Ä–∏–º–µ—Ä–Ω–æ –≤ 8 —Ä–∞–∑ –±—ã—Å—Ç—Ä–µ–µ –±–∞–∑–æ–≤–æ–π Python-–≤–µ—Ä—Å–∏–∏. –ù–æ –Ω–∞ –æ–±—â–µ–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ –ø—Ä–∏ —Ç–∞–∫–æ–π —Å–∫–æ—Ä–æ—Å—Ç–∏ –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è 124 –¥–Ω—è, —á—Ç–æ –≤—Å—ë —Ä–∞–≤–Ω–æ —Å–ª–∏—à–∫–æ–º –¥–æ–ª–≥–æ. –ü–æ—Ä–∞ –∑–∞–Ω—è—Ç—å—Å—è —Ä–µ–∞–ª—å–Ω–æ–π –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–µ–π.  

  

‚ñç –ò–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
-----------------------

  

–í–º–µ—Å—Ç–æ —Ç–æ–≥–æ —á—Ç–æ–±—ã –≥–∞–¥–∞—Ç—å, –∫–∞–∫ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥, –º—ã –∑–∞–ø—É—Å—Ç–∏–º –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤—â–∏–∫ –∏ –ø–æ—Å–º–æ—Ç—Ä–∏–º, –≥–¥–µ –≤ –Ω—ë–º —É–∑–∫–∏–µ –º–µ—Å—Ç–∞. –ù–∞ —Å–≤–æ—ë–º Mac —è –æ–±—ã—á–Ω–æ –∏—Å–ø–æ–ª—å–∑—É—é [Instruments.app](https://en.wikipedia.org/wiki/Instruments_(software)), –Ω–æ –Ω–µ–¥–∞–≤–Ω–æ –ø–æ–ø—Ä–æ–±–æ–≤–∞–ª [samply](https://github.com/mstange/samply/) –∏ –±—ã–ª –ø—Ä–∏—è—Ç–Ω–æ —É–¥–∏–≤–ª—ë–Ω! –û–Ω –≥–æ—Ä–∞–∑–¥–æ —É–¥–æ–±–Ω–µ–µ. –ü–æ—Ö–æ–∂–µ, —á—Ç–æ samply –ª—É—á—à–µ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å Rust –∫–∞–∫ –≤ –ø–ª–∞–Ω–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–∏–º–≤–æ–ª–æ–≤ (demangling), —Ç–∞–∫ –∏ –≤ –ø–ª–∞–Ω–µ –ø–µ—Ä–µ—Å—Ç—Ä–æ–π–∫–∏ —Å—Ç–µ–∫–∞ –≤—ã–∑–æ–≤–æ–≤. –í–æ—Ç —Å–∫—Ä–∏–Ω—à–æ—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–π —á–∞—Å—Ç–∏ —Ç—Ä–µ–π—Å–∞ samply –¥–ª—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ Rust:  

  

![](https://habrastorage.org/r/w1560/webt/yu/cx/7z/yucx7zknhaqxu9xdoqdv8ohmn1g.png)  

  

–û–∫–æ–ª–æ 75% –≤—Å–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–¥ –ø—Ä–æ–≤–æ–¥–∏—Ç –≤ `HashMap::get`! –ê –≤–æ—Ç –∏ –≤–∏–Ω–æ–≤–Ω–∞—è –≤ —ç—Ç–æ–º —Å—Ç—Ä–æ–∫–∞ –∫–æ–¥–∞:  

  


```
q_to_score[*q].get(u).copied()
```
  

–ü—Ä–æ–±–ª–µ–º–∞ –≤ —Ç–æ–º, —á—Ç–æ –º—ã —Ö—ç—à–∏—Ä—É–µ–º –∏ —Å—Ä–∞–≤–Ω–∏–≤–∞–µ–º 36-–±–∞–π—Ç–æ–≤—ã–µ —Å—Ç—Ä–æ–∫–∏ UUID, —á—Ç–æ –æ—á–µ–Ω—å –∑–∞—Ç—Ä–∞—Ç–Ω–æ. –ù–∞–º –Ω—É–∂–µ–Ω –±–æ–ª–µ–µ –∫–æ–º–ø–∞–∫—Ç–Ω—ã–π —Ç–∏–ø, –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–Ω–æ –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è —Å—Ç—Ä–æ–∫ –≤–æ–ø—Ä–æ—Å/–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å.  

  

–î–ª—è —ç—Ç–æ–≥–æ –º—ã —Å–æ–±–µ—Ä—ë–º –≤—Å–µ –≤–æ–ø—Ä–æ—Å—ã –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ `Vec` –∏ –ø—Ä–µ–¥—Å—Ç–∞–≤–∏–º –∫–∞–∂–¥—É—é –ø–∞—Ä—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å/–≤–æ–ø—Ä–æ—Å –ø–æ –∏—Ö –∏–Ω–¥–µ–∫—Å—É –≤ —ç—Ç–æ–º `Vec`. –ú–æ–∂–Ω–æ –ø—Ä–æ—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏–Ω–¥–µ–∫—Å—ã `usize` —Å —Ç–∏–ø–æ–º `Vec`, –Ω–æ –ª—É—á—à–µ –±—É–¥–µ—Ç –∑–∞–¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å –Ω–æ–≤—ã–µ —Ç–∏–ø—ã –¥–ª—è –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è –∫–∞–∂–¥–æ–≥–æ –≤–∏–¥–∞ –∏–Ω–¥–µ–∫—Å–∞. –ü–æ —Ñ–∞–∫—Ç—É –≤ –º–æ–µ–π —Ä–∞–±–æ—Ç–µ —ç—Ç–∞ –ø—Ä–æ–±–ª–µ–º–∞ –≤–æ–∑–Ω–∏–∫–∞–µ—Ç —Ç–∞–∫ —á–∞—Å—Ç–æ, —á—Ç–æ —è —É–∂–µ –Ω–∞–ø–∏—Å–∞–ª –¥–ª—è –Ω–µ—ë –∫—Ä–µ–π—Ç, [Indexical](https://docs.rs/indexical/0.6.0/indexical/index.html), –≤–∑—è–≤ –∑–∞ –æ—Å–Ω–æ–≤—É –∫—Ä–µ–π—Ç `[index_vec](https://docs.rs/index_vec/0.1.3/index_vec/index.html)`.   

  

–≠—Ç–∏ —Ç–∏–ø—ã –∏–Ω–¥–µ–∫—Å–æ–≤ –º—ã –æ–ø—Ä–µ–¥–µ–ª–∏–º —Ç–∞–∫:  

  


```
pub struct QuestionRef<'a>(pub &'a Question);
pub struct UserRef<'a>(pub &'a User);

define_index_type! {
  pub struct QuestionIdx for QuestionRef<'a> = u16;
}

define_index_type! {
  pub struct UserIdx for UserRef<'a> = u32;
}
```
  

`QuestionRef` –∏ `UserRef` ‚Äì —ç—Ç–æ –Ω–æ–≤—ã–µ —Ç–∏–ø—ã, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–∑–≤–æ–ª—è—é—Ç —Ä–µ–∞–ª–∏–∑–æ–≤—ã–≤–∞—Ç—å —Ç—Ä–µ–π—Ç—ã –≤ `&Question` –∏ `&User`. –ú–∞–∫—Ä–æ—Å `define_index_type` —Å–æ–∑–¥–∞—ë—Ç –Ω–æ–≤—ã–µ —Ç–∏–ø—ã –∏–Ω–¥–µ–∫—Å–∞ `QuestionIdx` –∏ `UserIdx`, –∫–æ—Ç–æ—Ä—ã–µ —Å–≤—è–∑—ã–≤–∞—é—Ç—Å—è —Å `QuestionRef` –∏ `UserRef`. –≠—Ç–∏ –∏–Ω–¥–µ–∫—Å—ã –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω—ã –∫–∞–∫ `u16` –∏ `u32` —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ.  

  

–ù–∞–∫–æ–Ω–µ—Ü, –º—ã –æ–±–Ω–æ–≤–ª—è–µ–º `k_corrset`, —á—Ç–æ–±—ã —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å `[IndexedDomain](https://docs.rs/indexical/0.6.0/indexical/struct.IndexedDomain.html)` –¥–ª—è –≤–æ–ø—Ä–æ—Å–æ–≤ –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –∞ –∑–∞—Ç–µ–º –Ω–∞ –ø—Ä–æ—Ç—è–∂–µ–Ω–∏–∏ –æ—Å—Ç–∞–≤—à–µ–π—Å—è —á–∞—Å—Ç–∏ –∫–æ–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–∏–ø—ã `QuestionIdx` –∏ `UserIdx`:  

  


```
fn k_corrset(data: &[Row], k: usize) -> Vec<&Question> {
  // —Å–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞—ë–º `IndexedDomain` –¥–ª—è –≤–æ–ø—Ä–æ—Å–æ–≤ –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.
  let (questions_set, users_set): (HashSet<_>, HashSet<_>) = data.iter()
    .map(|row| (QuestionRef(&row.question), UserRef(&row.user)))
    .unzip();
  let questions = IndexedDomain::from_iter(questions_set);
  let users = IndexedDomain::from_iter(users_set);

// –∑–∞—Ç–µ–º —Å–æ–∑–¥–∞—ë–º —Ç–µ –∂–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö, —á—Ç–æ –∏ —Ä–∞–Ω—å—à–µ, 
// –∑–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è `IndexedDomain::index` –¥–ª—è –ø–æ–∏—Å–∫–∞ –∏–Ω–¥–µ–∫—Å–æ–≤.
// –æ–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –≤ —Ç–∏–ø–∞—Ö –∫–ª—é—á–µ–π HashMap.
  let q_to_score: HashMap<QuestionIdx, HashMap<UserIdx, u32>> = 
    utils::group_by(data.iter().map(|r| (
      questions.index(&(QuestionRef(&r.question))),
      users.index(&(UserRef(&r.user))),
      r.score,
    )));
  let u_to_score: HashMap<UserIdx, HashMap<QuestionIdx, u32>> = 
    utils::group_by(data.iter().map(|r| (
      users.index(&(UserRef(&r.user))),
      questions.index(&(QuestionRef(&r.question))),
      r.score,
    )));  
  let all_grand_totals = // same code

  let all_qs = questions.indices();
  all_qs.combinations(k)
    .filter_map(|qs: Vec<QuestionIdx>| {
      // —Ç–æ—Ç –∂–µ –∫–æ–¥.
    })
    .max_by_key(|(_, r)| FloatOrd(*r))
    .unwrap().0
    // –Ω—É–∂–Ω–æ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å –∏–Ω–¥–µ–∫—Å—ã –æ–±—Ä–∞—Ç–Ω–æ –≤ –∑–Ω–∞—á–µ–Ω–∏—è.
    .into_iter().map(|idx| questions.value(idx).0).collect()
}
```
  

–í—Å—é —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é —Ç–∞–∫–∂–µ –º–æ–∂–µ—Ç–µ –Ω–∞–π—Ç–∏ –Ω–∞ [GitHub](https://github.com/willcrichton/corrset-benchmark/blob/main/src/inner/indexed.rs). –ß—Ç–æ –∫–∞—Å–∞–µ—Ç—Å—è API –∫—Ä–µ–π—Ç–∞ Indexical, —Ç–æ –æ–Ω –æ–ø–∏—Å–∞–Ω –≤ [–¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏](https://docs.rs/indexical/0.6.0/indexical/index.html).  

  

–°–Ω–æ–≤–∞ –∑–∞–ø—É—Å–∫–∞–µ–º –±–µ–Ω—á–º–∞—Ä–∫ –¥–ª—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ —Ü–∏–∫–ª–∞ –≤—ã—á–∏—Å–ª–µ–Ω–∏–π, –∏ —Ç–µ–ø–µ—Ä—å –æ–Ω –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –∑–∞ 1,0 –º—Å, —á—Ç–æ –≤ 4 —Ä–∞–∑–∞ –±—ã—Å—Ç—Ä–µ–µ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏ –∏ –≤ 35 —Ä–∞–∑ –±—ã—Å—Ç—Ä–µ–µ —Å–∞–º–æ–π –ø–µ—Ä–≤–æ–π. –ò—Ç–æ–≥–æ –Ω–∞ –≤—Å–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è —Å–µ–π—á–∞—Å —É –Ω–∞—Å —É–π–¥—ë—Ç —É–∂–µ 30 –¥–Ω–µ–π ‚Äì –ø—Ä–æ–¥–æ–ª–∂–∏–º!  

  

‚ñç –ò–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–ª–ª–µ–∫—Ü–∏–π
--------------------------

  

–ü–æ–≤—Ç–æ—Ä–∏–º –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ:  

  

![](https://habrastorage.org/r/w1560/webt/wk/qi/_e/wkqi_eiezor64xiuuftnp1utrbe.png)  

  

–ù–∞–¥–æ –∂–µ, –ø–æ –ø—Ä–µ–∂–Ω–µ–º—É –±–æÃÅ–ª—å—à—É—é —á–∞—Å—Ç—å –≤—Ä–µ–º–µ–Ω–∏ –º—ã –ø—Ä–æ–≤–æ–¥–∏–º –≤ `HashMap::get`. –ê —á—Ç–æ, –µ—Å–ª–∏ –≤–æ–æ–±—â–µ –∏–∑–±–∞–≤–∏—Ç—å—Å—è –æ—Ç —Ö—ç—à-—Ç–∞–±–ª–∏—Ü? `HashMap<&User, u32>` ‚Äì —ç—Ç–æ, –ø–æ —Å—É—Ç–∏, —Ç–æ –∂–µ, —á—Ç–æ –∏ `Vec<Option<u32>>`, –≥–¥–µ —É –∫–∞–∂–¥–æ–≥–æ `&User` –µ—Å—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å. –ù–∞–ø—Ä–∏–º–µ—Ä, –≤ –æ–±–ª–∞—Å—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π `["a", "b", "c"]` —Ö—ç—à-—Ç–∞–±–ª–∏—Ü–∞ `{"b" => 1}` —Ä–∞–≤–Ω–æ–∑–Ω–∞—á–Ω–∞ –≤–µ–∫—Ç–æ—Ä—É `[None, Some(1), None]`. –î–ª—è —ç—Ç–æ–≥–æ –≤–µ–∫—Ç–æ—Ä–∞ —Ç—Ä–µ–±—É–µ—Ç—Å—è –±–æ–ª—å—à–µ –ø–∞–º—è—Ç–∏ (–∏–∑-–∑–∞ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤ `None`), –Ω–æ –æ–Ω –ø–æ–≤—ã—à–∞–µ—Ç —Å–∫–æ—Ä–æ—Å—Ç—å –ø–æ–∏—Å–∫–∞ –ø–∞—Ä –∫–ª—é—á/–∑–Ω–∞—á–µ–Ω–∏–µ –∑–∞ —Å—á—ë—Ç –∏–∑–±–µ–∂–∞–Ω–∏—è —Ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è.  

  

–ú—ã –ø—ã—Ç–∞–µ–º—Å—è –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å, –∏ —Å —É—á—ë—Ç–æ–º –º–∞—Å—à—Ç–∞–±–∞ –Ω–∞—à–µ–≥–æ –¥–∞—Ç–∞—Å–µ—Ç–∞ –º–æ–∂–µ–º –ø–æ–∑–≤–æ–ª–∏—Ç—å —Å–µ–±–µ —Ä–∞–∑–º–µ–Ω—è—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –ø–∞–º—è—Ç—å –Ω–∞ –ø—Ä–∏—Ä–æ—Å—Ç –≤ —Å–∫–æ—Ä–æ—Å—Ç–∏ –≤—ã—á–∏—Å–ª–µ–Ω–∏–π. –ú—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º Indexical, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç —Ç–∏–ø `[DenseIndexMap<K, V>](https://docs.rs/indexical/0.6.0/indexical/map/struct.DenseIndexMap.html)`, –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ —Ä–µ–∞–ª–∏–∑—É–µ–º—ã–π –∫–∞–∫ `Vec<V>` –∏ –∏–Ω–¥–µ–∫—Å–∏—Ä—É–µ–º—ã–π –ø–æ—Å—Ä–µ–¥—Å—Ç–≤–æ–º `K::Index`.  

  

–û—Å–Ω–æ–≤–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ `k_corrset` –≤ —Ç–æ–º, —á—Ç–æ –º—ã –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤—Å–µ –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö –≤ —Å–∂–∞—Ç—ã–µ –∏–Ω–¥–µ–∫—Å–Ω—ã–µ –∫–∞—Ä—Ç—ã:  

  


```
pub type QuestionMap<'a, T> = DenseIndexMap<'a, QuestionRef<'a>, T>;
pub type UserMap<'a, T> = DenseIndexMap<'a, UserRef<'a>, T>;

fn k_corrset(data: &[Row], k: usize) -> Vec<&Question> {
 // –∫–∞–∫ –∏ —Ä–∞–Ω—å—à–µ —Å–æ–∑–¥–∞—ë–º –æ–±–ª–∞—Å—Ç–∏ `users` –∏ `questions`.

// –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º q_to_score –∫–∞–∫ –ø—É—Å—Ç—É—é —Å–∂–∞—Ç—É—é –∫–∞—Ä—Ç—É.
  let mut q_to_score: QuestionMap<'_, UserMap<'_, Option<u32>>> = 
    QuestionMap::new(&questions, |_| UserMap::new(&users, |_| None));  

  // –∑–∞–ø–æ–ª–Ω—è–µ–º q_to_score –¥–∞—Ç–∞—Å–µ—Ç–æ–º.
  for r in data {
    q_to_score
      .get_mut(&QuestionRef(&r.question))
      .unwrap()
      .insert(UserRef(&r.user), Some(r.score));
  }

  let grand_totals = UserMap::new(&users, |u| {
    q_to_score.values().filter_map(|v| v[u]).sum::<u32>()
  });

  let all_qs = questions.indices();
  all_qs.combinations(k)
    // –ø–æ—á—Ç–∏ —Ç–æ—Ç –∂–µ –∫–æ–¥, —Å–º. –Ω–∏–∂–µ
}
```
  

–ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ —Ü–∏–∫–ª–∞ –≤ —Ç–æ–º, —á—Ç–æ –Ω–∞—à –∫–æ–¥, –∫–æ—Ç–æ—Ä—ã–π –≤—ã–≥–ª—è–¥–µ–ª —Ç–∞–∫:  

  


```
q_to_score[*q].get(u).copied()
```
  

–¢–µ–ø–µ—Ä—å –≤—ã–≥–ª—è–¥–∏—Ç —Ç–∞–∫:  

  


```
q_to_score[*q][u]
```
  

–ü–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ –±–µ–Ω—á–º–∞—Ä–∫–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç, —á—Ç–æ —Ç–µ–ø–µ—Ä—å –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π —Ü–∏–∫–ª –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –∑–∞ 181 –º–∫—Å, —Ç–æ –µ—Å—Ç—å –≤ 6 —Ä–∞–∑ –±—ã—Å—Ç—Ä–µ–µ –ø–æ—Å–ª–µ–¥–Ω–µ–π –≤–µ—Ä—Å–∏–∏ –∏ –≤ 199 —Ä–∞–∑ –±—ã—Å—Ç—Ä–µ–µ Python-–≤–µ—Ä—Å–∏–∏. –ù–∞–º —É–¥–∞–ª–æ—Å—å —Å–æ–∫—Ä–∞—Ç–∏—Ç—å –æ–±—â–µ–µ –≤—Ä–µ–º—è –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –¥–æ 5,3 –¥–Ω—è.  

  

‚ñç –ö–æ–Ω—Ç—Ä–æ–ª—å –≥—Ä–∞–Ω–∏—Ü
-----------------

  

–ï—â—ë –æ–¥–∏–Ω —É–¥–∞—Ä –ø–æ –±—ã—Å—Ç—Ä–æ–¥–µ–π—Å—Ç–≤–∏—é –Ω–∞–Ω–æ—Å–∏—Ç –∫–∞–∂–¥–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–≤–∞–¥—Ä–∞—Ç–Ω—ã—Ö —Å–∫–æ–±–æ–∫ –¥–ª—è –∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏—è `DenseIndexMap`. –ü—Ä–∏–≤–µ–¥—ë–Ω–Ω—ã–π –Ω–∏–∂–µ –≤–µ–∫—Ç–æ—Ä –≤—ã–ø–æ–ª–Ω—è–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫—É –≥—Ä–∞–Ω–∏—Ü, –Ω–æ –Ω–∞—à –∫–æ–¥ –≤ –µ–≥–æ —Ç–µ–∫—É—â–µ–º –≤–∏–¥–µ –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –≤—ã–π–¥–µ—Ç –∑–∞ –≥—Ä–∞–Ω–∏—Ü—ã –≤–µ–∫—Ç–æ—Ä–∞. –Ø –Ω–µ —Å–º–æ–≥ –Ω–∞–π—Ç–∏ —ç—Ç—É –ø—Ä–æ–≤–µ—Ä–∫—É –≤ –≤—ã–≤–æ–¥–µ samply, –Ω–æ –æ–Ω–∞ –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ –≤–ª–∏—è–µ—Ç –Ω–∞ –±–µ–Ω—á–º–∞—Ä–∫, –∞ –∑–Ω–∞—á–∏—Ç, –µ—ë —Å—Ç–æ–∏—Ç —É–±—Ä–∞—Ç—å.   

  

–î–æ —ç—Ç–æ–≥–æ –Ω–∞—à –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π —Ü–∏–∫–ª –≤—ã–≥–ª—è–¥–µ–ª —Ç–∞–∫:  

  


```
let q_total = qs.iter()
  .map(|q| q_to_score[*q][u])
  .sum::<Option<u32>>()?;
let grand_total = all_grand_totals[u];
```
  

–ü–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å –ø–æ–º–æ—â—å—é `get_unchecked` –Ω–∞—à –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π —Ü–∏–∫–ª –ø—Ä–∏–Ω—è–ª —Ç–∞–∫–æ–π –≤–∏–¥:  

  


```
let q_total = qs.iter()
  .map(|q| unsafe {
    let u_scores = q_to_score.get_unchecked(q);
    *u_scores.get_unchecked(u)
  })
  .sum::<Option<u32>>()?;
let grand_total = unsafe { *all_grand_totals.get_unchecked(u) };
```
  

–ë–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤—ã—Ö–æ–¥–∞ –∑–∞ –≥—Ä–∞–Ω–∏—Ü—ã —Ü–∏–∫–ª –æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –Ω–µ–±–µ–∑–æ–ø–∞—Å–Ω—ã–º, –ø–æ—ç—Ç–æ–º—É –º—ã –ø–æ–º–µ—á–∞–µ–º –±–ª–æ–∫–∏ –∫–∞–∫ `unsafe`.  

  

–ü—Ä–∏ –æ—á–µ—Ä–µ–¥–Ω–æ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –±–µ–Ω—á–º–∞—Ä–∫–∞ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π —Ü–∏–∫–ª –∑–∞–Ω–∏–º–∞–µ—Ç 156 –º–∫—Å, —á—Ç–æ –≤ 1,16 —Ä–∞–∑–∞ –±—ã—Å—Ç—Ä–µ–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –≤–∞—Ä–∏–∞–Ω—Ç–∞ –∏ –≤ 229 —Ä–∞–∑ –±—ã—Å—Ç—Ä–µ–µ –±–∞–∑–æ–≤–æ–π Python-–≤–µ—Ä—Å–∏–∏. –¢–µ–ø–µ—Ä—å –Ω–∞ –≤—Å–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è 4,6 –¥–Ω—è.  

  

‚ñç –ë–∏—Ç–æ–≤—ã–µ –∫–∞—Ä—Ç—ã
---------------

  

–ù–∞ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç –º—ã –¥–æ–±–∏–ª–∏—Å—å —É—Å–∫–æ—Ä–µ–Ω–∏—è –≤ 225 —Ä–∞–∑, –∞ –∑–Ω–∞—á–∏—Ç, –Ω–∞–º –µ—â—ë –ø—Ä–µ–¥—Å—Ç–æ–∏—Ç —É–ª—É—á—à–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ—á—Ç–∏ –Ω–∞ —Ç—Ä–∏ –ø–æ—Ä—è–¥–∫–∞. –î–ª—è —ç—Ç–æ–≥–æ –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–æ—Å–º—ã—Å–ª–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ —Ü–∏–∫–ª–∞.  

  

–°–µ–π—á–∞—Å –æ–Ω, –ø–æ —Å—É—Ç–∏, –≤—ã–≥–ª—è–¥–∏—Ç —Ç–∞–∫:  

  


```
for each subset of questions $qs:
  for each user $u:
    for each question $q in $qs:
      if $u answered $q: add $u's score on $q to a running total
      else: skip to the next user
    $r = correlation($u's totals on $qs, $u's grand total)
```
  

–í–∞–∂–Ω–∞—è –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç—å –Ω–∞—à–∏—Ö –¥–∞–Ω–Ω—ã—Ö –≤ —Ç–æ–º, —á—Ç–æ –æ–Ω–∏ —Ñ–æ—Ä–º–∏—Ä—É—é—Ç —Ä–∞–∑—Ä–µ–∂—ë–Ω–Ω—É—é –º–∞—Ç—Ä–∏—Ü—É. –ù–∞ –ª—é–±–æ–π –æ—Ç–¥–µ–ª—å–Ω–æ –≤–∑—è—Ç—ã–π –≤–æ–ø—Ä–æ—Å –ª–∏—à—å 20% –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–∞–ª–∏ –æ—Ç–≤–µ—Ç. –ï—Å–ª–∏ –±—Ä–∞—Ç—å 5 –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤, —Ç–æ –Ω–∞ –Ω–∏—Ö –æ—Ç–≤–µ—Ç –¥–∞–ª–æ –µ—â—ë –º–µ–Ω—å—à–µ–µ —á–∏—Å–ª–æ –ª—é–¥–µ–π. –ü–æ—ç—Ç–æ–º—É –µ—Å–ª–∏ –º—ã —Å–º–æ–∂–µ–º —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ —Å–Ω–∞—á–∞–ª–∞ –æ–ø—Ä–µ–¥–µ–ª—è—Ç—å, –∫–∞–∫–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –æ—Ç–≤–µ—Ç–∏–ª–∏ –Ω–∞ –≤—Å–µ 5 –≤–æ–ø—Ä–æ—Å–æ–≤, —Ç–æ –∏—Ç–æ–≥–æ–≤—ã–π —Ü–∏–∫–ª –±—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å –º–µ–Ω—å—à–µ –∏—Ç–µ—Ä–∞—Ü–∏–π (–∏ –æ—Å–≤–æ–±–æ–¥–∏—Ç—Å—è –æ—Ç –≤–µ—Ç–≤–ª–µ–Ω–∏–π). –ß—Ç–æ-—Ç–æ –≤—Ä–æ–¥–µ —Ç–∞–∫–æ–≥–æ:  

  


```
for each subset of questions $qs:
  $qs_u = all users who have answered every question in $qs
  for each user $u in $qs_u:
    for each question $q in $qs:
      add $u's score on $q to a running total
    $r = correlation($u's scores on $qs, $u's grand total)
```
  

–ö–∞–∫ –∂–µ –Ω–∞–º –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç—å –º–Ω–æ–∂–µ—Å—Ç–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –æ—Ç–≤–µ—Ç–∏–≤—à–∏—Ö –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –≤–æ–ø—Ä–æ—Å? –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `[HashSet](https://doc.rust-lang.org/std/collections/struct.HashSet.html)`, –Ω–æ –º—ã —É–∂–µ –≤–∏–¥–µ–ª–∏, —á—Ç–æ —Ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—ã—á–∏—Å–ª–∏—Ç–µ–ª—å–Ω–æ –∑–∞—Ç—Ä–∞—Ç–Ω–æ. –ü–æ—Å–∫–æ–ª—å–∫—É –Ω–∞—à–∏ –¥–∞–Ω–Ω—ã–µ –∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞–Ω—ã, –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–æ–ª–µ–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É [–±–∏—Ç–æ–≤–æ–π –∫–∞—Ä—Ç—ã](https://en.wikipedia.org/wiki/Bit_array), –≤ –∫–æ—Ç–æ—Ä–æ–π —Å –ø–æ–º–æ—â—å—é –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –±–∏—Ç–æ–≤ –ø–∞–º—è—Ç–∏ –≤—ã—Ä–∞–∂–∞–µ—Ç—Å—è –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏–µ –∏–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –æ–±—ä–µ–∫—Ç–∞. Indexical –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –µ—â—ë –æ–¥–Ω—É –∞–±—Å—Ç—Ä–∞–∫—Ü–∏—é –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –±–∏—Ç–æ–≤—ã—Ö –∫–∞—Ä—Ç —Å –Ω–∞—à–∏–º–∏ –∏–Ω–¥–µ–∫—Å–∞–º–∏ –Ω–æ–≤–æ–≥–æ —Ç–∏–ø–∞: `[IndexSet](https://docs.rs/indexical/0.6.0/indexical/struct.IndexSet.html)`.  

  

–†–∞–Ω–µ–µ –Ω–∞—à–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö `q_to_score` –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–ª–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤–æ–ø—Ä–æ—Å–æ–≤ –≤ –∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –≤–µ–∫—Ç–æ—Ä –±–∞–ª–ª–æ–≤ (—Ç–æ –µ—Å—Ç—å, `UserMap<'_, Option<u32>>`). –¢–µ–ø–µ—Ä—å –º—ã –∏–∑–º–µ–Ω–∏–º `Option<u32>` –Ω–∞ `u32` –∏ –¥–æ–±–∞–≤–∏–º –±–∏—Ç–æ–≤—É—é –∫–∞—Ä—Ç—É, –æ–ø–∏—Å—ã–≤–∞—é—â—É—é –º–Ω–æ–∂–µ—Å—Ç–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –æ—Ç–≤–µ—Ç–∏–≤—à–∏—Ö –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –≤–æ–ø—Ä–æ—Å. –ü–µ—Ä–≤–∞—è –ø–æ–ª–æ–≤–∏–Ω–∞ –∏–∑–º–µ–Ω—ë–Ω–Ω–æ–≥–æ –∫–æ–¥–∞ –±—É–¥–µ—Ç –≤—ã–≥–ª—è–¥–µ—Ç—å —Ç–∞–∫:  

  


```
type UserSet<'a> = IndexSet<'a, UserRef<'a>>;

let mut q_to_score: QuestionMap<'_, (UserSet<'_>, UserMap<'_, u32>)> = 
  QuestionMap::new(&questions, |_| (
    UserMap::<'_, u32>::new(&users, |_| 0),
    UserSet::new(&users),
  ));
for r in data {
  let (scores, set) = &mut q_to_score.get_mut(&QuestionRef(&r.question)).unwrap();
  scores.insert(UserRef(&r.user), r.score);
  set.insert(UserRef(&r.user));
}
```
  

–ó–∞–º–µ—Ç—å—Ç–µ, —á—Ç–æ `q_to_score` —Ç–µ–ø–µ—Ä—å, –ø–æ —Å—É—Ç–∏, —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è, —Ç–∞–∫ –∫–∞–∫ –º—ã —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º `0` –¥–ª—è —Ç–µ—Ö, –∫—Ç–æ –Ω–∞ –≤–æ–ø—Ä–æ—Å –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª. –ù–∞–º –Ω—É–∂–Ω–æ –æ—Å—Ç–µ—Ä–µ–≥–∞—Ç—å—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è—Ö –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π.  

  

–î–∞–ª–µ–µ –º—ã –æ–±–Ω–æ–≤–ª—è–µ–º –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π —Ü–∏–∫–ª, —á—Ç–æ–±—ã –æ–Ω —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞–ª –Ω–æ–≤–æ–º—É –ø—Å–µ–≤–¥–æ–∫–æ–¥—É:  

  


```
let all_qs = questions.indices();
all_qs.combinations(k)
  .filter_map(|qs: Vec<QuestionIdx>| {
    // –≤—ã—á–∏—Å–ª—è–µ–º –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ –º–Ω–æ–∂–µ—Å—Ç–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞.
    let mut users = q_to_score[qs[0]].1.clone();
    for q in &qs[1..] {
      users.intersect(&q_to_score[*q].1);
    }

    let (qs_totals, grand_totals): (Vec<_>, Vec<_>) = users.indices()
      // —Ç–æ–ª—å–∫–æ .map, –∞ –Ω–µ .filter_map, –∫–∞–∫ —Ä–∞–Ω—å—à–µ.
      .map(|u| {
        let q_total = qs.iter()          
          .map(|q| unsafe {
            let (u_scores, _) = q_to_score.get_unchecked(q);
            *u_scores.get_unchecked(u)
          })
          // —Ç–æ–ª—å–∫–æ u32, –∞ –Ω–µ Option<u32>, –∫–∞–∫ —Ä–∞–Ω—å—à–µ.
          .sum::<u32>();
        let grand_total = unsafe { *all_grand_totals.get_unchecked(u) };
        (q_total as f64, grand_total as f64)
      })
      .unzip();
    let r = utils::correlation(&qs_totals, &grand_totals);
    (!r.is_nan()).then_some((qs, r))
  })
  // –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ –ø—Ä–µ–∂–Ω–∏–π.
```
  

–°–Ω–æ–≤–∞ –≤—ã–ø–æ–ª–Ω—è–µ–º –±–µ–Ω—á–º–∞—Ä–∫ –∏ –≤–∏–¥–∏–º, —á—Ç–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π —Ü–∏–∫–ª –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –∑–∞ 47 –º–∫—Å ‚Äì —Ç–æ –µ—Å—Ç—å –≤ 3,4 —Ä–∞–∑–∞ –±—ã—Å—Ç—Ä–µ–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –≤–∞—Ä–∏–∞–Ω—Ç–∞ –∏ –≤ 769 —Ä–∞–∑ –±—ã—Å—Ç—Ä–µ–µ –∏–∑–Ω–∞—á–∞–ª—å–Ω–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ Python. –¢–µ–ø–µ—Ä—å –º—ã —Å–æ–∫—Ä–∞—Ç–∏–ª–∏ –æ–±—â–µ–µ –≤—Ä–µ–º—è –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –¥–æ 1,4 –¥–Ω—è.  

  

‚ñç SIMD
------

  

–ù–æ–≤–∞—è –≤—ã—á–∏—Å–ª–∏—Ç–µ–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ –≤—Å—ë —É—Å–∫–æ—Ä–∏–ª–∞, –Ω–æ –ø–æ–∫–∞ —á—Ç–æ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ. –ü–æ–≤—Ç–æ—Ä–∏–º –ø—Ä–æ–≤–µ—Ä–∫—É —Å –ø–æ–º–æ—â—å—é samply:  

  

![](https://habrastorage.org/r/w1560/webt/qi/pk/y8/qipky8jqfyd26tzyalk8fot36kq.png)  

  

–¢–µ–ø–µ—Ä—å –∫–æ–¥ –≤—Å—ë –æ—Å–Ω–æ–≤–Ω–æ–µ –≤—Ä–µ–º—è –ø—Ä–æ–≤–æ–¥–∏—Ç –∑–∞ –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ–º –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–π –±–∏—Ç–æ–≤—ã—Ö –∫–∞—Ä—Ç. –≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –Ω–∞–º –Ω—É–∂–Ω–æ –∑–∞–≥–ª—è–Ω—É—Ç—å –≤ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–π –±–∏–±–ª–∏–æ—Ç–µ–∫–∏. –í –∫–∞—á–µ—Å—Ç–≤–µ —Ç–∞–∫–æ–π –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –±–∏—Ç–æ–≤—ã–º–∏ –∫–∞—Ä—Ç–∞–º–∏ Indexical –∏—Å–ø–æ–ª—å–∑—É–µ—Ç [bitvec](https://docs.rs/bitvec/1.0.1/bitvec/index.html). –ù–∞ 2023 –≥–æ–¥ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –º–µ—Ç–æ–¥–∞ `intersect` –≤ –Ω–µ–π –≤—ã–≥–ª—è–¥–∏—Ç –ø—Ä–∏–º–µ—Ä–Ω–æ —Ç–∞–∫:  

  


```
fn intersect(dst: &mut BitSet, src: &BitSet) {
  for (n1, n2): (&mut u64, &u64) in dst.iter_mut().zip(&src) {
    *n1 &= *n2;
  }
}
```
  

–ó–Ω–∞—á–∏—Ç, bitvec –≤—ã–ø–æ–ª–Ω—è–µ—Ç `AND` –¥–ª—è –æ–¥–Ω–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞ `u64` –∑–∞ —Ä–∞–∑. –ù–æ, –∫–∞–∫ –æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è, –≤ –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–µ –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–æ–≤ –µ—Å—Ç—å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ [SIMD](https://en.wikipedia.org/wiki/Single_instruction,_multiple_data) (Single Instruction stream, Multiple Data stream, –æ–¥–Ω–∞ –∫–æ–º–∞–Ω–¥–∞ ‚Äì –º–Ω–æ–∂–µ—Å—Ç–≤–æ –ø–æ—Ç–æ–∫–æ–≤ –¥–∞–Ω–Ω—ã—Ö), –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–µ –¥–ª—è –º–∞–Ω–∏–ø—É–ª—è—Ü–∏–∏ —Å –±–∏—Ç–∞–º–∏ –≤ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —ç–ª–µ–º–µ–Ω—Ç–∞—Ö `u64` –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ. –ö —Å—á–∞—Å—Ç—å—é, –≤ Rust –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç—Å—è —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞–ª—å–Ω—ã–π API SIMD `[std::simd](https://doc.rust-lang.org/std/simd/index.html)`, –∫–æ—Ç–æ—Ä—ã–π –º—ã –∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º. –í –ø—Ä–∏–º–µ—Ä–Ω–æ–º –≤–∏–¥–µ –≤–µ—Ä—Å–∏—è SIMD –¥–ª—è –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–π –±–∏—Ç–æ–≤—ã—Ö –∫–∞—Ä—Ç –≤—ã–≥–ª—è–¥–∏—Ç —Ç–∞–∫:  

  


```
fn intersect(dst: &mut SimdBitSet, src: &SimdBitSet) {
  for (n1, n2): (&mut u64x4, &u64x4) in dst.iter_mut().zip(&src) {
    *n1 &= *n2;
  }
}
```
  

–ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–µ –æ—Ç–ª–∏—á–∏–µ –≤ —Ç–æ–º, —á—Ç–æ –º—ã –∑–∞–º–µ–Ω–∏–ª–∏ –ø—Ä–∏–º–∏—Ç–∏–≤–Ω—ã–π —Ç–∏–ø `u64` —Ç–∏–ø–æ–º SIMD `[u64x4](https://doc.rust-lang.org/std/simd/type.u64x4.html)`, –∏ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ Rust —Å–æ–∑–¥–∞—ë—Ç –æ–¥–Ω—É –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é SIMD –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ü–∏–∏ `&=`, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—â–µ–π —á–µ—Ç—ã—Ä–µ —ç–ª–µ–º–µ–Ω—Ç–∞ `u64` –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ.  

  

–ê –≥–¥–µ –Ω–∞–º –≤–∑—è—Ç—å `BitSet`, —É—Å–∫–æ—Ä–µ–Ω–Ω—ã–π —Å –ø–æ–º–æ—â—å—é SIMD? [Bitvec](https://docs.rs/bitvec/1.0.1/bitvec/index.html) –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç SIMD. –ù–∞ [crates.io](https://crates.io/) –µ—Å—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–µ—à–µ–Ω–∏–π, –∏ —è –ø–æ–ø—Ä–æ–±–æ–≤–∞–ª –æ–¥–Ω–æ –∏–∑ –Ω–∏—Ö –ø–æ–¥ –Ω–∞–∑–≤–∞–Ω–∏–µ–º [bitsvec](https://github.com/psiace/bitsvec). –î–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–π –ø–æ–¥—Ö–æ–¥–∏—Ç –æ—Ç–ª–∏—á–Ω–æ, –Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π –≤ —ç—Ç–æ–º –∫—Ä–µ–π—Ç–µ –∏—Ç–µ—Ä–∞—Ç–æ—Ä, –æ—Ç–≤–µ—á–∞—é—â–∏–π –∑–∞ –ø–æ–∏—Å–∫ –∏–Ω–¥–µ–∫—Å–æ–≤ –±–∏—Ç–æ–≤ 1, –æ–∫–∞–∑–∞–ª—Å—è –º–µ–¥–ª–µ–Ω–Ω—ã–º. –ü–æ—ç—Ç–æ–º—É —è —Å–∫–æ–ø–∏—Ä–æ–≤–∞–ª –æ—Å–Ω–æ–≤–Ω—ã–µ –∫—É—Å–∫–∏ bitsvec –∏ –Ω–∞–ø–∏—Å–∞–ª –±–æ–ª–µ–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–π –∏—Ç–µ—Ä–∞—Ç–æ—Ä, —Å –∫–æ—Ç–æ—Ä—ã–º –≤—ã –º–æ–∂–µ—Ç–µ –æ–∑–Ω–∞–∫–æ–º–∏—Ç—å—Å—è –≤ [–∏—Å—Ö–æ–¥–Ω–æ–º –∫–æ–¥–µ Indexical](https://github.com/willcrichton/indexical/blob/913fbf5830f4d5acedd23e04841e453ed2659165/src/bitset/simd.rs).   

  

–ë–ª–∞–≥–æ–¥–∞—Ä—è –∞–±—Å—Ç—Ä–∞–∫—Ü–∏—è–º Indexical, –¥–ª—è –ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∏ –±–∏—Ç–æ–≤—ã—Ö –∫–∞—Ä—Ç, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º—ã—Ö —Å –ø–æ–º–æ—â—å—é SIMD, –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è –ª–∏—à—å –∏–∑–º–µ–Ω–∏—Ç—å –ø—Å–µ–≤–¥–æ–Ω–∏–º —Ç–∏–ø–æ–≤ –≤ —Ñ—É–Ω–∫—Ü–∏–∏ `k_corrset`. –Ø —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–ª —Å —Ä–∞–∑–Ω—ã–º–∏ —Ä–∞–∑–º–µ—Ä–∞–º–∏ –ª–∏–Ω–∏–π –≤–µ–∫—Ç–æ—Ä–æ–≤, –∏ –Ω–∞ –º–æ–µ–π –º–∞—à–∏–Ω–µ —Å —ç—Ç–∏–º –¥–∞—Ç–∞—Å–µ—Ç–æ–º —Å–∞–º—ã–º —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–º –æ–∫–∞–∑–∞–ª—Å—è `u64x16`.  

  

–°–Ω–æ–≤–∞ –∑–∞–ø—É—Å–∫–∞–µ–º –±–µ–Ω—á–º–∞—Ä–∫, –∏ –Ω–∞—à —Ü–∏–∫–ª –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –∑–∞ 1,35 –º–∫—Å, —Ç–æ –µ—Å—Ç—å –≤ 34 —Ä–∞–∑–∞ –±—ã—Å—Ç—Ä–µ–µ –ø–æ—Å–ª–µ–¥–Ω–µ–π –≤–µ—Ä—Å–∏–∏ –∏ –≤ 26,459 —Ä–∞–∑ –±—ã—Å—Ç—Ä–µ–µ —Å–∞–º–æ–π –ø–µ—Ä–≤–æ–π. –û–±—â–µ–µ –≤—Ä–µ–º—è –≤—ã—á–∏—Å–ª–µ–Ω–∏—è —Å–æ–∫—Ä–∞—Ç–∏–ª–æ—Å—å –¥–æ 57 –º–∏–Ω—É—Ç.  

  

‚ñç –í—ã–¥–µ–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏
------------------

  

–ú—ã —É–∂–µ –ø—Ä–∏–±–ª–∏–∑–∏–ª–∏—Å—å –∫ –ø–∏–∫–æ–≤–æ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏. (–í–∞–º —ç—Ç–æ –º–æ–∂–µ—Ç –Ω–µ –ø–æ–Ω—Ä–∞–≤–∏—Ç—å—Å—è, –Ω–æ‚Ä¶) –í–µ—Ä–Ω—ë–º—Å—è –∫ –¥–∞–Ω–Ω—ã–º –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤—â–∏–∫–∞ –∏ –Ω–∞ —ç—Ç–æ—Ç —Ä–∞–∑ —Ä–∞—Å—Å–º–æ—Ç—Ä–∏–º –∏—Ö –∏–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ (–≤ –∫–æ—Ç–æ—Ä–æ–º –æ—Ç—Ä–∞–∂–µ–Ω—ã —Å–∞–º—ã–µ —á–∞—Å—Ç–æ –≤—ã–∑—ã–≤–∞–µ–º—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –≤ –ª–∏—Å—Ç–æ–≤—ã—Ö —É–∑–ª–∞—Ö –¥–µ—Ä–µ–≤–∞ –≤—ã–∑–æ–≤–æ–≤):  

  

![](https://habrastorage.org/r/w1560/webt/sf/z4/p3/sfz4p3wxms56ajdzbgrwl9aproi.png)  

  

–°–∞–º–æ–µ —É–∑–∫–æ–µ –º–µ—Å—Ç–æ ‚Äì —ç—Ç–æ –∏—Ç–µ—Ä–∞—Ç–æ—Ä –±–∏—Ç–æ–≤—ã—Ö –∫–∞—Ä—Ç. –°–µ—Ä—å—ë–∑–Ω–æ! –ù–æ –∑–¥–µ—Å—å –µ—â—ë –µ—Å—Ç—å —Ä—è–¥ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π: `memmove`, `realloc`, `allocate` ‚Äî –≤—Å—ë –≤–µ—Ä–Ω–æ, –º—ã –≤—ã–¥–µ–ª—è–µ–º –≤–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–º —Ü–∏–∫–ª–µ –∏—Ç–µ—Ä–∞—Ç–æ—Ä–∞ –ø–∞–º—è—Ç—å. –í —á–∞—Å—Ç–Ω–æ—Å—Ç–∏, –∑–¥–µ—Å—å –µ—Å—Ç—å –±–∏—Ç–æ–≤–∞—è –∫–∞—Ä—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –∫–æ—Ç–æ—Ä—É—é –º—ã –∏–∑–Ω–∞—á–∞–ª—å–Ω–æ –∫–ª–æ–Ω–∏—Ä—É–µ–º, –∏ –µ—Å—Ç—å –¥–≤–∞ –≤–µ–∫—Ç–æ—Ä–∞ –¥–ª—è `qs_totals` –∏ `grand_totals`, –∫–æ—Ç–æ—Ä—ã–µ –º—ã –≤—ã–¥–µ–ª—è–µ–º —Å –ø–æ–º–æ—â—å—é `unzip`.  

  

–ß—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –≤—ã–¥–µ–ª–µ–Ω–∏—è, –º—ã —Å–æ–∑–¥–∞—ë–º —ç—Ç–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö –∑–∞—Ä–∞–Ω–µ–µ —Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–º —Ä–∞–∑–º–µ—Ä–æ–º –∏ –∑–∞—Ç–µ–º —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏–º –≤ –Ω–∏—Ö –∑–∞–ø–∏—Å—å:  

  


```
// –∑–∞–±–ª–∞–≥–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–µ –≤—ã–¥–µ–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö.
let mut qs_totals = vec![0.; users.len()]
let mut grand_totals = vec![0.; users.len()];
let mut user_set = IndexSet::new(&users);

let all_qs = questions.indices();
all_qs.combinations(k)
  .filter_map(|qs| {
    // –∏—Å–ø–æ–ª—å–∑—É–µ–º `clone_from` –≤–º–µ—Å—Ç–æ `clone`, —á—Ç–æ–±—ã –≤—ã–ø–æ–ª–Ω–∏—Ç—å –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –±–µ–∑ –≤—ã–¥–µ–ª–µ–Ω–∏—è.
    user_set.clone_from(&q_to_score[qs[0]].1);
    for q in &qs[1..] {
      user_set.intersect(&q_to_score[*q].1);
    }

    let mut n = 0;
    for (i, u) in user_set.indices().enumerate() {
      let q_total = qs.iter()
        .map(|q| unsafe {
          let (u_scores, _) = q_to_score.get_unchecked(q);
          *u_scores..get_unchecked(u)
        })
        .sum::<u32>();
      let grand_total = unsafe { *all_grand_totals.get_unchecked(u) };

      // –æ–±–Ω–æ–≤–ª—è–µ–º totals/grand_totals –Ω–∞ –º–µ—Å—Ç–µ –±–µ–∑ –ø–µ—Ä–µ–¥–∞—á–∏ –≤ –≤–µ–∫—Ç–æ—Ä.
      unsafe {
        *qs_totals.get_unchecked_mut(i) = q_total as f64;
        *grand_totals.get_unchecked_mut(i) = grand_total as f64;
      }

      n += 1;
    }

    // –ø–µ—Ä–µ–¥–∞—ë–º —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–µ `n` —ç–ª–µ–º–µ–Ω—Ç–æ–≤!
    let r = utils::correlation(&qs_totals[..n], &grand_totals[..n]);
    (!r.is_nan()).then_some((qs, r))
  })
```
  

–ü–æ–≤—Ç–æ—Ä—è–µ–º –±–µ–Ω—á–º–∞—Ä–∫ –∏ –≤–∏–¥–∏–º, —á—Ç–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π —Ü–∏–∫–ª —É—Å–∫–æ—Ä–∏–ª—Å—è –¥–æ 1,09 –º–∫—Å, —á—Ç–æ –≤ 1,24 —Ä–∞–∑–∞ –±—ã—Å—Ç—Ä–µ–µ –ø—Ä–æ—à–ª–æ–π –≤–µ—Ä—Å–∏–∏ –∏ –≤ 32,940 —Ä–∞–∑ –±—ã—Å—Ç—Ä–µ–µ –æ—Å–Ω–æ–≤—ã –Ω–∞ Python. –¢–µ–ø–µ—Ä—å –Ω–∞ –æ–±—â–µ–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ —É–π–¥—ë—Ç –≤—Å–µ–≥–æ 46 –º–∏–Ω—É—Ç.  

  

–í–ø–µ—á–∞—Ç–ª—è–µ—Ç, —á—Ç–æ –∞–ª–ª–æ–∫–∞—Ç–æ—Ä –∫—É—á–∏ –æ–∫–∞–∑–∞–ª—Å—è –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±—ã—Å—Ç—Ä –∏ –ø–æ–≤–ª–∏—è–ª –Ω–∞ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Å–æ–≤—Å–µ–º –Ω–µ–∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ.  

  

–í —Ç–∞–±–ª–∏—Ü–µ 1 –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∞ —Å–≤–æ–¥–∫–∞, –æ—Ç—Ä–∞–∂–∞—é—â–∞—è –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è, –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ–µ —É—Å–∫–æ—Ä–µ–Ω–∏–µ –∏ –ø—Ä–∏–º–µ—Ä–Ω–æ–µ –æ–±—â–µ–µ –≤—Ä–µ–º—è –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —É—Ä–æ–≤–Ω—è –±–µ–Ω—á–º–∞—Ä–∫–∞.  

  

–¢–∞–±–ª–∏—Ü–∞ 1: –ü–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –±—ã—Å—Ç—Ä–æ–¥–µ–π—Å—Ç–≤–∏—è –¥–ª—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ —Ü–∏–∫–ª–∞:  

  



| –£—Ä–æ–≤–µ–Ω—å | –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è | –£—Å–∫–æ—Ä–µ–Ω–∏–µ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –ø—Ä–æ—à–ª–æ–≥–æ —É—Ä–æ–≤–Ω—è | –£—Å–∫–æ—Ä–µ–Ω–∏–µ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ Python | –û—Ü–µ–Ω–æ—á–Ω–æ–µ –≤—Ä–µ–º—è –ø–æ–ª–Ω–æ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è |
| --- | --- | --- | --- | --- |
| Python | 35.85 –º—Å | 1.00√ó |  | 2.88 –ª–µ—Ç |
| 0\_basic | 4.24 –º—Å | 8.46√ó | 8.46√ó | 124.40 –¥–Ω—è |
| 1\_indexed | 1.03 –º—Å | 4.11√ó | 34.78√ó | 30.25 –¥–Ω—è |
| 2\_imap | 180.52 –º–∫—Å | 5.71√ó | 198.60√ó | 5.30 –¥–Ω—è |
| 3\_bchecks | 156.23 –º–∫—Å | 1.16√ó | 229.47√ó | 4.59 –¥–Ω—è |
| 4\_bitset | 46.60 –º–∫—Å | 3.35√ó | 769.26√ó | 1.37 –¥–Ω—è |
| 5\_simd | 1.35 –º–∫—Å | 34.40√ó | 26,459.54√ó | 57.26 –º–∏–Ω |
| 6\_alloc | 1.09 –º–∫—Å | 1.24√ó | 32,940.02√ó | 45.99 –º–∏–Ω |

  

–î–æ—Å—Ç–∏–≥–Ω—É—Ç–æ–µ –∞–±—Å–æ–ª—é—Ç–Ω–æ–µ —É—Å–∫–æ—Ä–µ–Ω–∏–µ –æ—Ç—Ä–∞–∂–µ–Ω–æ –Ω–∞ —Ä–∏—Å—É–Ω–∫–µ –Ω–∏–∂–µ. –û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ, —á—Ç–æ –æ—Å—å y –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∞ –≤ –ª–æ–≥–∞—Ä–∏—Ñ–º–∏—á–µ—Å–∫–æ–º –º–∞—Å—à—Ç–∞–±–µ.  

  

![](https://habrastorage.org/r/w1560/webt/wv/yf/xm/wvyfxm3x_uasfrwfxm2thaiwrek.png)  

*–¢—Ä–µ–Ω–¥ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ —Ü–∏–∫–ª–∞*  

  

‚ñç –ü–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º
-------------

  

–ö —ç—Ç–æ–º—É –º–æ–º–µ–Ω—Ç—É –º—ã, –∫–∞–∑–∞–ª–æ—Å—å –±—ã, –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏—Å—á–µ—Ä–ø–∞–ª–∏ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ —Å—Ä–µ–¥—Å—Ç–≤–∞. –õ–∏—á–Ω–æ —è –Ω–µ –º–æ–≥—É –ø—Ä–∏–¥—É–º–∞—Ç—å –∫–∞–∫–∏–µ-–ª–∏–±–æ –µ—â—ë –ø—Ä–∏—ë–º—ã –¥–ª—è –æ—â—É—Ç–∏–º–æ–≥–æ —É—Å–∫–æ—Ä–µ–Ω–∏—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ —Ü–∏–∫–ª–∞ ‚Äì –Ω–∞–ø–∏—à–∏—Ç–µ –≤ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è—Ö, –µ—Å–ª–∏ —É –≤–∞—Å –µ—Å—Ç—å –∏–¥–µ–∏ –Ω–∞ —ç—Ç–æ—Ç —Å—á—ë—Ç. –ù–æ —É –Ω–∞—Å –æ—Å—Ç–∞–ª—Å—è –µ—â—ë –æ–¥–∏–Ω, —Ç–µ–ø–µ—Ä—å —É–∂–µ –ø–æ—Å–ª–µ–¥–Ω–∏–π, –ø—Ä–∏—ë–º ‚Äì –ø–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º. –≠—Ç–∞ –∑–∞–¥–∞—á–∞ –∫—Ä–∞–π–Ω–µ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞, –∞ –∑–Ω–∞—á–∏—Ç –º–æ–∂–Ω–æ —Å –ª—ë–≥–∫–æ—Å—Ç—å—é —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ —Ü–∏–∫–ª–∞ –ø–æ –Ω–µ—Å–∫–æ–ª—å–∫–∏–º —è–¥—Ä–∞–º. –° –ø–æ–º–æ—â—å—é [Rayon](https://docs.rs/rayon/1.8.0/rayon/index.html) —ç—Ç–æ –¥–µ–ª–∞–µ—Ç—Å—è –Ω–∞ —Ä–∞–∑:  

  


```
let all_qs = questions.indices();
all_qs.combinations(k)
  .par_bridge()
  .map_init(
    || (vec![0.; users.len()], vec![0.; users.len()], IndexSet::new(&users)),
    |(qs_totals, grand_totals, user_set), qs| {
      // —Ç–æ—Ç –∂–µ –∫–æ–¥
    })
    // —Ç–æ—Ç –∂–µ –∫–æ–¥
```
  

–ú–µ—Ç–æ–¥ `par_bridge` –ø–æ–ª—É—á–∞–µ—Ç –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã–π –∏—Ç–µ—Ä–∞—Ç–æ—Ä –∏ –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç –µ–≥–æ –≤ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–π. –§—É–Ω–∫—Ü–∏—è `map_init` –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—É—é –∫–∞—Ä—Ç—É —Å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–º –ø–æ—Ç–æ–∫—É —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º, –ø–æ—ç—Ç–æ–º—É –º—ã –ø–æ-–ø—Ä–µ–∂–Ω–µ–º—É –æ–±—Ö–æ–¥–∏–º—Å—è –±–µ–∑ –≤—ã–¥–µ–ª–µ–Ω–∏—è.   

  

–î–ª—è –æ—Ü–µ–Ω–∫–∏ –≤–Ω–µ—à–Ω–µ–≥–æ —Ü–∏–∫–ª–∞ –Ω–∞–º –Ω—É–∂–µ–Ω –¥—Ä—É–≥–æ–π –±–µ–Ω—á–º–∞—Ä–∫. –Ø –≤—ã–ø–æ–ª–Ω–∏–ª —ç—Ç–æ—Ç —Ü–∏–∫–ª –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ 5,000,000 –∫–æ–º–±–∏–Ω–∞—Ü–∏–π –≤–æ–ø—Ä–æ—Å–æ–≤ –∑–∞ —Ä–∞–∑ —Å –ø–æ–º–æ—â—å—é Criterion, –∏—Å–ø–æ–ª—å–∑—É—è –∑–∞–¥–∞–Ω–Ω—É—é —Å—Ç—Ä–∞—Ç–µ–≥–∏—é. –≠—Ç–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–π –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ, —á—Ç–æ–±—ã –æ–±–Ω–∞—Ä—É–∂–∏—Ç—å –æ—Ç–ª–∏—á–∏—è –≤ –∫–∞–∂–¥–æ–º –≤–Ω–µ—à–Ω–µ–º —Ü–∏–∫–ª–µ –±–µ–∑ –º–Ω–æ–≥–æ–Ω–µ–¥–µ–ª—å–Ω–æ–≥–æ –æ–∂–∏–¥–∞–Ω–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –±–µ–Ω—á–º–∞—Ä–∫–∞.  

  

–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Ç–µ—Å—Ç–∞ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ–π —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –¥–ª—è —Å–∞–º–æ–≥–æ –±—ã—Å—Ç—Ä–æ–≥–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ —Ü–∏–∫–ª–∞ –∑–∞–Ω–∏–º–∞–µ—Ç 6,8 —Å–µ–∫—É–Ω–¥. –í –º–æ—ë–º MacBook Pro 10 —è–¥–µ—Ä, –∑–Ω–∞—á–∏—Ç –ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ Rayon –º–æ–∂–Ω–æ –æ–∂–∏–¥–∞—Ç—å –ø—Ä–∏–º–µ—Ä–Ω–æ 10-–∫—Ä–∞—Ç–Ω–æ–≥–æ —É—Å–∫–æ—Ä–µ–Ω–∏—è. –ü–æ—Å–ª–µ –∞–Ω–∞–ª–∏–∑–∞ —ç—Ç–æ–π –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–π —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –º—ã –ø–æ–ª—É—á–∞–µ–º 4,2 —Å–µ–∫—É–Ω–¥—ã –Ω–∞ –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ 5,000,000 –∫–æ–º–±–∏–Ω–∞—Ü–∏–π. –£—Å–∫–æ—Ä–µ–Ω–∏–µ —Å–æ—Å—Ç–∞–≤–∏–ª–æ –≤—Å–µ–≥–æ 1,6 —Ä–∞–∑–∞. –ü–æ–∑–æ—Ä!  

  

‚ñç –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∞–Ω–∏–µ
---------------

   

–í–µ—Ä–Ω—ë–º—Å—è –∫ –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤—â–∏–∫—É, —á—Ç–æ–±—ã –Ω–∞–π—Ç–∏ –ø—Ä–∏—á–∏–Ω—É –ø—Ä–æ–±–ª–µ–º —Å –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ–º:  

  

![](https://habrastorage.org/r/w1560/webt/9v/d6/g8/9vd6g8xe6fi71_rdkqnrcixn3ey.png)  

  

–ù–∞—à–∏ –ø–æ—Ç–æ–∫–∏ –±–æÃÅ–ª—å—à—É—é —á–∞—Å—Ç—å –≤—Ä–µ–º–µ–Ω–∏ –ø—Ä–æ–≤–æ–¥—è—Ç –∑–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∏–µ–º –∏ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∏–µ–º –º—å—é—Ç–µ–∫—Å–∞. –ü–æ–ª—É—á–∞–µ—Ç—Å—è, —É –Ω–∞—Å –µ—Å—Ç—å –ø—Ä–æ–±–ª–µ–º—ã —Å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–µ–π. –î–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ, –µ—Å–ª–∏ –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ –ø—Ä–æ—á–µ—Å—Ç—å [–¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é](https://docs.rs/rayon/1.8.0/rayon/iter/trait.ParallelBridge.html) –∫ `par_bridge`, —Ç–æ –º—ã –Ω–∞–π–¥—ë–º –∫–ª—é—á–µ–≤–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ:  

  


> –ò—Ç–µ—Ä–∏—Ä—É–µ–º—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –ø–æ –æ–¥–Ω–æ–º—É –∏–∑–≤–ª–µ–∫–∞—é—Ç—Å—è —Ñ—É–Ω–∫—Ü–∏–µ–π `next()` –∏–∑ –∫–∞–∂–¥–æ–≥–æ –≥–æ—Ç–æ–≤–æ–≥–æ –∫ —Ä–∞–±–æ—Ç–µ –ø–æ—Ç–æ–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ, –≤ —Å–≤—è–∑–∏ —Å —á–µ–º —ç—Ç–æ—Ç –ø—Ä–æ—Ü–µ—Å—Å –º–æ–∂–µ—Ç —Å—Ç–∞—Ç—å —É–∑–∫–∏–º –º–µ—Å—Ç–æ–º, –µ—Å–ª–∏ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã–π –∏—Ç–µ—Ä–∞—Ç–æ—Ä –Ω–µ –±—É–¥–µ—Ç –ø–æ—Å–ø–µ–≤–∞—Ç—å –∑–∞ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–º —Å–ø—Ä–æ—Å–æ–º —Å–æ —Å—Ç–æ—Ä–æ–Ω—ã –ø–æ—Ç–æ–∫–æ–≤.

  

–ü–æ—Ö–æ–∂–µ, —á—Ç–æ –ø—Ä–æ—Ü–µ—Å—Å –ø–µ—Ä–µ–¥–∞—á–∏ –º–µ–∂–¥—É –∏—Ç–µ—Ä–∞—Ç–æ—Ä–æ–º `Itertools::combinations` –∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–º –º–æ—Å—Ç–æ–º Rayon —Å–ª–∏—à–∫–æ–º –º–µ–¥–ª–µ–Ω–Ω—ã–π. –£—á–∏—Ç—ã–≤–∞—è, —á—Ç–æ —É –Ω–∞—Å –µ—Å—Ç—å –æ–≥—Ä–æ–º–Ω–æ–µ —á–∏—Å–ª–æ –∫–æ–º–±–∏–Ω–∞—Ü–∏–π, –ø—Ä–æ—Å—Ç—ã–º —Å–ø–æ—Å–æ–±–æ–º –∏–∑–±–µ–∂–∞–Ω–∏—è —ç—Ç–æ–≥–æ —É–∑–∫–æ–≥–æ –º–µ—Å—Ç–∞ –±—É–¥–µ—Ç –±–æ–ª–µ–µ –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ø—Ä–∏—Å–≤–∞–∏–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á. –¢–æ –µ—Å—Ç—å –º—ã –º–æ–∂–µ–º –æ–±—ä–µ–¥–∏–Ω—è—Ç—å –≤–º–µ—Å—Ç–µ –º–Ω–æ–∂–µ—Å—Ç–≤–æ –∫–æ–º–±–∏–Ω–∞—Ü–∏–π –≤–æ–ø—Ä–æ—Å–æ–≤ –∏ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å –∏—Ö –≤ –ø–æ—Ç–æ–∫ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ.  

  

–î–ª—è —ç—Ç–æ–≥–æ —è –Ω–∞—Å–∫–æ—Ä–æ –Ω–∞–±—Ä–æ—Å–∞–ª –≥—Ä—É–ø–ø–∏—Ä—É—é—â–∏–π –∏—Ç–µ—Ä–∞—Ç–æ—Ä, –∫–æ—Ç–æ—Ä—ã–π –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `[ArrayVec](https://docs.rs/arrayvec/0.7.4/arrayvec/struct.ArrayVec.html)` –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –≤—ã–¥–µ–ª–µ–Ω–∏—è.  

  


```
pub struct Batched<const N: usize, I: Iterator> {
  iter: I,
}

impl<const N: usize, I: Iterator> Iterator for Batched<N, I> {
  type Item = ArrayVec<I::Item, N>;

  #[inline]
  fn next(&mut self) -> Option<Self::Item> {
    let batch = ArrayVec::from_iter((&mut self.iter).take(N));
    (!batch.is_empty()).then_some(batch)
  }
}
```
  

–ó–∞—Ç–µ–º –º—ã –∏–∑–º–µ–Ω–∏–º –≤–Ω–µ—à–Ω–∏–π —Ü–∏–∫–ª, –¥–æ–±–∞–≤–∏–≤ –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫—É –≤ –∏—Ç–µ—Ä–∞—Ç–æ—Ä –∫–æ–º–±–∏–Ω–∞—Ü–∏–π, –∏ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π, —á—Ç–æ–±—ã —Ç–æ—Ç —É–ø–ª–æ—â–∞–ª –∫–∞–∂–¥—ã–π –ø–∞–∫–µ—Ç:  

  


```
let all_qs = questions.indices();
all_qs.combinations(k)
  .batched::<1024>()
  .par_bridge()
  .map_init(
    || (vec![0.; users.len()], vec![0.; users.len()], IndexSet::new(&users)),
    |(qs_totals, grand_totals, user_set), qs_batch| {
      qs_batch
        .into_iter()
        .filter_map(|qs| {
          // —Ç–æ—Ç –∂–µ –∫–æ–¥.
        })
        .collect_vec()
    })
    .flatten()
    // —Ç–æ—Ç –∂–µ –∫–æ–¥
```
  

–°–Ω–æ–≤–∞ –ø–æ–≤—Ç–æ—Ä—è–µ–º –±–µ–Ω—á–º–∞—Ä–∫ –≤–Ω–µ—à–Ω–µ–≥–æ —Ü–∏–∫–ª–∞, –∏ —Ç–µ–ø–µ—Ä—å –≥—Ä—É–ø–ø–∏—Ä—É—é—â–∏–π –∏—Ç–µ—Ä–∞—Ç–æ—Ä –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç 5,000,000 –∫–æ–º–±–∏–Ω–∞—Ü–∏–π –∑–∞ 982 –º—Å. –≠—Ç–æ –≤ 6,9 —Ä–∞–∑–∞ –±—ã—Å—Ç—Ä–µ–µ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞, —á—Ç–æ —É–∂–µ –≥–æ—Ä–∞–∑–¥–æ –ª—É—á—à–µ –¥–ª—è –º–æ–µ–π 10-—è–¥–µ—Ä–Ω–æ–π –º–∞—à–∏–Ω—ã. –í –∏–¥–µ–∞–ª–µ –º—ã –±—ã –ø—Ä–∏–±–ª–∏–∑–∏–ª–∏—Å—å –∫ 10-–∫—Ä–∞—Ç–Ω–æ–º—É —É—Å–∫–æ—Ä–µ–Ω–∏—é, –Ω–æ —è –¥—É–º–∞—é, —Å—Ç–∞—Ç—å—è –∏ –±–µ–∑ —Ç–æ–≥–æ –ø–æ–ª—É—á–∏–ª–∞—Å—å –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–æ–ª—å—à–æ–π. –°–≤–æ–¥–∫–∞ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –≤–Ω–µ—à–Ω–µ–≥–æ —Ü–∏–∫–ª–∞ –ø—Ä–∏–≤–µ–¥–µ–Ω–∞ –≤ —Ç–∞–±–ª–∏—Ü–µ 2.  

  

–¢–∞–±–ª–∏—Ü–∞ 2: –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –≤–Ω–µ—à–Ω–µ–≥–æ —Ü–∏–∫–ª–∞:  

  



| –£—Ä–æ–≤–µ–Ω—å | –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è | –£—Å–∫–æ—Ä–µ–Ω–∏–µ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏ | –£—Å–∫–æ—Ä–µ–Ω–∏–µ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ Python | –û—Ü–µ–Ω–æ—á–Ω–æ–µ –≤—Ä–µ–º—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è |
| --- | --- | --- | --- | --- |
| 0\_serial | 6.80 —Å | 26,342.63√ó |  | 57.51 –º–∏–Ω |
| 1\_parallel | 4.22 —Å | 1.61√ó | 42,439.31√ó | 35.70 –º–∏–Ω |
| 2\_batched | 982.46 –º—Å | 4.30√ó | 182,450.94√ó | 8.30 –º–∏–Ω |

  

‚ñç –ó–∞–∫–ª—é—á–µ–Ω–∏–µ
------------

  

–ß–µ–≥–æ –∂–µ –º—ã –¥–æ—Å—Ç–∏–≥–ª–∏? –ü—Ä–∏ `k=5` –∏—Å—Ö–æ–¥–Ω–æ–π –ø—Ä–æ–≥—Ä–∞–º–º–µ Python –ø–æ—Ç—Ä–µ–±–æ–≤–∞–ª–æ—Å—å –±—ã 2,9 –≥–æ–¥–∞ –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è. –ò—Ç–æ–≥–æ–≤–æ–π –∂–µ –ø—Ä–æ–≥—Ä–∞–º–º–µ Rust –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É —Ç–æ–≥–æ –∂–µ –¥–∞—Ç–∞—Å–µ—Ç–∞ –Ω—É–∂–Ω–æ –≤—Å–µ–≥–æ 8 –º–∏–Ω—É—Ç. –¢–æ –µ—Å—Ç—å –º—ã –¥–æ–±–∏–ª–∏—Å—å —É—Å–∫–æ—Ä–µ–Ω–∏—è –ø–æ—á—Ç–∏ –≤ 180,000 —Ä–∞–∑. –ö–∞–∫–∏–µ –æ—Å–Ω–æ–≤–Ω—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –º—ã –ø—Ä–∏–º–µ–Ω–∏–ª–∏:  

  

* –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∫–æ–º–ø–∏–ª—è—Ç–æ—Ä–∞ Rust;
* —Ö—ç—à-—á–∏—Å–ª–∞ –≤–º–µ—Å—Ç–æ —Å—Ç—Ä–æ–∫;
* (–∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ) –≤–µ–∫—Ç–æ—Ä—ã –≤–º–µ—Å—Ç–æ —Ö—ç—à-—Ç–∞–±–ª–∏—Ü;
* –±–∏—Ç–æ–≤—ã–µ –∫–∞—Ä—Ç—ã –¥–ª—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–Ω–æ—Å—Ç–∏;
* SIMD –¥–ª—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–π –±–∏—Ç–æ–≤—ã—Ö –∫–∞—Ä—Ç.
* –ú–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ—Å—Ç—å –¥–ª—è —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã –ø–æ –Ω–µ—Å–∫–æ–ª—å–∫–∏–º —è–¥—Ä–∞–º;
* –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫—É –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏—è —É–∑–∫–æ–≥–æ –º–µ—Å—Ç–∞ –ø—Ä–∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–∏ —Ä–∞–±–æ—Ç—ã;

  

–ú–æ–∂–Ω–æ –ª–∏ –¥–æ–±–∏—Ç—å—Å—è –±–æ–ª—å—à–µ–≥–æ? –°—Ñ–æ—Ä–º–∏—Ä—É–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –ø—Ä–æ—Ñ–∏–ª—å:  

  

![](https://habrastorage.org/r/w1560/webt/59/bz/fm/59bzfm6etvjgzbi2bchs1o6wteq.png)  

  

–ö–æ–¥ 38% –≤—Ä–µ–º–µ–Ω–∏ –ø—Ä–æ–≤–æ–¥–∏—Ç –≤ –∏—Ç–µ—Ä–∞—Ç–æ—Ä–µ –±–∏—Ç–æ–≤—ã—Ö –∫–∞—Ä—Ç –∏ 36% –∑–∞ –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ–º –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–π —ç—Ç–∏—Ö –∫–∞—Ä—Ç. –ï—â—ë 12% —É—Ö–æ–¥–∏—Ç –Ω–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–∑–Ω–∞—á–∞–ª—å–Ω–æ–π –±–∏—Ç–æ–≤–æ–π –∫–∞—Ä—Ç—ã –¥–ª—è –∑–∞–¥–∞–Ω–Ω–æ–≥–æ –º–Ω–æ–∂–µ—Å—Ç–≤–∞ –≤–æ–ø—Ä–æ—Å–æ–≤. –ï—â—ë –æ—Å—Ç–∞—ë—Ç—Å—è –¥–ª–∏–Ω–Ω—ã–π —Ö–≤–æ—Å—Ç –¥—Ä—É–≥–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π –≤—Ä–æ–¥–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –∫–æ—Ä—Ä–µ–ª—è—Ü–∏–∏.  

  

–Ø –ø—Ä–∏–ª–æ–∂–∏–ª –≤—Å–µ —É—Å–∏–ª–∏—è, —á—Ç–æ–±—ã —É—Å–∫–æ—Ä–∏—Ç—å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –±–∏—Ç–æ–≤—ã—Ö –∫–∞—Ä—Ç —Å –ø–æ–º–æ—â—å—é SIMD, –ø–æ—ç—Ç–æ–º—É –Ω–µ –∑–Ω–∞—é, –∫–∞–∫ –µ—â—ë –º–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å —ç—Ç–∏ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏. –ú–æ–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å +10% –∫ —Å–∫–æ—Ä–æ—Å—Ç–∏ –∑–∞ —Å—á—ë—Ç —Ç–æ—á–µ—á–Ω–æ–π –ø–æ–¥—Å—Ç—Ä–æ–π–∫–∏ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –∫–æ–Ω—Å—Ç–∞–Ω—Ç (—Ä–∞–∑–º–µ—Ä–∞ –ª–∏–Ω–∏–π –≤–µ–∫—Ç–æ—Ä–æ–≤, —Ä–∞–∑–º–µ—Ä–∞ –ø–∞–∫–µ—Ç–æ–≤ –∏ —Ç–∞–∫ –¥–∞–ª–µ–µ), –Ω–æ —è –Ω–µ –¥—É–º–∞—é, —á—Ç–æ —É–¥–∞—Å—Ç—Å—è –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—å—Å—è –µ—â—ë –Ω–∞ —Ü–µ–ª—ã–π –ø–æ—Ä—è–¥–æ–∫. –ï—Å–ª–∏ —É –≤–∞—Å –µ—Å—Ç—å –∏–¥–µ–∏, –ø—Ä–∏–≥–ª–∞—à–∞—é –∏—Ö –æ–ø—Ä–æ–±–æ–≤–∞—Ç—å: [github.com/willcrichton/corrset-benchmark](https://github.com/willcrichton/corrset-benchmark)  

  

–ö—Ä–æ–º–µ —Ç–æ–≥–æ, –µ—Å–ª–∏ –≤–∞–º –∏–∑–≤–µ—Å—Ç–Ω–æ –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–æ–µ —Ä–µ—à–µ–Ω–∏–µ —ç—Ç–æ–π –∑–∞–¥–∞—á–∏, —Ç–æ –µ—Å—Ç—å –±–æ–ª–µ–µ –≥—Ä–∞–º–æ—Ç–Ω—ã–π —Å–ø–æ—Å–æ–± –ø–æ–ª—É—á–∏—Ç—å –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç –±–µ–∑ –±—Ä—É—Ç—Ñ–æ—Ä—Å–∞, –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —Å–æ–æ–±—â–∏—Ç–µ. –ê —Ç–∞–∫ –Ω–∞–¥–µ—é—Å—å, —á—Ç–æ –≤ —Å—Ç–∞—Ç—å–µ –≤—ã –Ω–∞—à–ª–∏ –¥–ª—è —Å–µ–±—è —á—Ç–æ-—Ç–æ –Ω–æ–≤–æ–µ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –≤ Rust.  

  


> **[–£–∑–Ω–∞–≤–∞–π—Ç–µ –æ –Ω–æ–≤—ã—Ö –∞–∫—Ü–∏—è—Ö –∏ –ø—Ä–æ–º–æ–∫–æ–¥–∞—Ö –ø–µ—Ä–≤—ã–º–∏ –∏–∑ –Ω–∞—à–µ–≥–æ Telegram-–∫–∞–Ω–∞–ª–∞ üí∞](https://t.me/ruvds_community)**

[![](https://habrastorage.org/r/w780q1/webt/os/g2/ms/osg2msglmcba81cfkh0vl0nlnu4.jpeg)](http://ruvds.com/ru-rub?utm_source=habr&utm_medium=article&utm_campaign=Bright_Translate&utm_content=kak_v_180,000_raz_uskorit_analiz_dannyx_s_pomoshhyu_rust)